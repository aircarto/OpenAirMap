<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="https://aircarto.fr/images/favicon.ico" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script> -->



    <!-- AJAX -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    <!-- my files -->
    <script src="js_scripts/NebuleAir.js"></script>
    <script src="js_scripts/purpleAir.js"></script>
    <script src="js_scripts/AtmoSudRef.js"></script>
    <script src="js_scripts/AtmoSudMicro.js"></script>
    <script src="js_scripts/sensorCommunity.js"></script>
    <script src="js_scripts/AtmoSudModelisation.js"></script>
    <script src="js_scripts/api_purpleair.js"></script>

    <script src="geojson/paca.geojson"></script>


    <!-- style CSS  -->
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/plugins/exporting.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-hash/0.2.1/leaflet-hash.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <!-- <script src="https://cdn.rawgit.com/hayeswise/Leaflet.PointInPolygon/v1.0.0/wise-leaflet-pip.js"></script> -->
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet.snogylop@0.4.0/src/leaflet.snogylop.min.js"></script>

    <title>Open Air Map</title>
</head>

<body>

    <script>
        HTMLCanvasElement.prototype.getContext = function(origFn) {
          return function(type, attribs) {
            attribs = attribs || {};
            attribs.preserveDrawingBuffer = true;
            return origFn.call(this, type, attribs);
          };
        }(HTMLCanvasElement.prototype.getContext);
        </script>

    <!-- LA CARTE -->
    <div id="map"></div>

    <!-- Toast de chargement des données -->
    <!-- <div class="toast-container position-fixed end-0 p-3" style="bottom:10px;">
        <div class="toast align-items-center" id="loadToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Chargement des données <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </div> -->
                <!-- <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button> -->
            <!-- </div>
        </div>
    </div> -->

       <!-- Toast de chargement des données -->
       <div class="toast-container position-fixed end-0 p-3" style="bottom:10px;">
        <div class="toast align-items-center" id="messageToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Attention: <span id="message"></span>
                </div>
            </div>
        </div>
    </div>




    <!-- Boutons PM1 PM2.5 PM10 -->
    <div class="btn-group" id="div_buttonPM" role="group">
        <button id="button_PM1" class="btn btn-outline-primary">PM1</button>
        <button id="button_PM25" class="btn btn-primary">PM2.5</button>
        <button id="button_PM10" class="btn btn-outline-primary">PM10</button>
    </div>

    <!-- Bouton mon NebuleAir -->
    <div id="div_button_monNebuleAir"><a id="button_monNebuleAir" class="btn btn-primary" role="button" href="https://nebuleair.fr/monNebuleAir.php">Mon NebuleAir</a></div>

    <!-- Bouton dropdown Choix des capteurs -->
    <div class="dropdown" id="div_checkbox_choixCapteur">
        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
            Choix des capteurs
        </button>
        <ul class="dropdown-menu">
            <li><input type="checkbox" id="checkbox_micro_stationsParticuliers" name="checkbox_micro_stationsParticuliers" /><label for="checkbox_micro_stationsParticuliers">Micro-stations NebuleAir particuliers</label></li>
            <li><input type="checkbox" id="checkbox_sensor_community" name="checkbox_sensor_community" /><label for="checkbox_sensor_community"></label>Capteurs Sensor.Community</label>
            </li>
            <li><input type="checkbox" id="checkbox_stationsRefAtmoSud" name="checkbox_stationsRefAtmoSud" /><label for="checkbox_stationsRefAtmoSud">Stations de Référence AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_micro_stationsAtmoSud" name="checkbox_micro_stationsAtmoSud" /><label for="checkbox_micro_stationsAtmoSud">Micro-stations AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_modelisationPMAtmoSud" name="checkbox_modelisationPMAtmoSud" /><label for="checkbox_modelisationPMAtmoSud">Modélisation horaire PM AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_modelisationICAIRAtmoSud" name="checkbox_modelisationICAIRAtmoSud" /><label for="checkbox_modelisationICAIRAtmoSud">Modélisation horaire ICAIRh AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_purpleAir" name="checkbox_purpleAir" /><label for="checkbox_purpleAir">Capteurs PurpleAir</label></li>
        </ul>
    </div>


    <!-- Seuils PM -->
    <div class="btn-group" id="div_button_seuils_PM125" role="group">
        <button class="btn" id="btn_bon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="0 à 10 &#181;g/m&#179;">Bon</button>
        <button class="btn" id="btn_moyen" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="11 à 20 &#181;g/m&#179;">Moyen</button>
        <button class="btn" id="btn_degrade" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="21 à 25 &#181;g/m&#179;">Dégradé</button>
        <button class="btn" id="btn_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="26 à 50 &#181;g/m&#179;">Mauvais</button>
        <button class="btn" id="btn_tres_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="51 à 75 &#181;g/m&#179;">Très Mauvais</button>
        <button class="btn" id="btn_extr_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title=">75 &#181;g/m&#179;">Extr. Mauvais</button>
    </div>

    <div class="btn-group" id="div_button_seuils_PM10" role="group">
        <button class="btn" id="btn_bon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="0 à 20 &#181;g/m&#179;">Bon</button>
        <button class="btn" id="btn_moyen" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="21 à 40 &#181;g/m&#179;">Moyen</button>
        <button class="btn" id="btn_degrade" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="41 à 50 &#181;g/m&#179;">Dégradé</button>
        <button class="btn" id="btn_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="51 à 100 &#181;g/m&#179;">Mauvais</button>
        <button class="btn" id="btn_tres_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="101 à 150 &#181;g/m&#179;">Très Mauvais</button>
        <button class="btn" id="btn_extr_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title=">150 &#181;g/m&#179;">Extr. Mauvais</button>
    </div>

    <!-- Boutons pas de temps -->
    <div class="btn-group" id="div_button_pas_de_temps" role="group">
        <button class="btn btn btn-primary" id="btn_actuel">2 minutes</button>
        <button class="btn btn-outline-primary" id="btn_quartHoraire">Quart-horaire</button>
        <button class="btn btn-outline-primary" id="btn_horaire">Horaire</button>
        <button class="btn btn-outline-primary" id="btn_journalier">Journalier</button>
    </div>

    <button type="button" class="btn btn-outline-primary" id="button_horloge"></button>

    <button type="button" class="btn btn-primary" id="button_screenshot">Faire une photo</button>


    <!-- Les Logos -->
    <!-- <div id="logoAirCarto"><a href="https://aircarto.fr/"><img src="img/logoAirCarto.png" alt=""></a></div> -->

    <!-- LE SIDE PANEL avec les graphiques (id "sidePanel") -->
    <div class="row text-center">
        <div class="col-5">
            <div class="card m-3" id="sidePanel" style="display: none;">
                <!-- Bouton pour fermer le panel -->
                <button type="button" class="btn-close position-absolute top-0 end-0" aria-label="Close" style="margin: 5px ;" onclick="CloseSidePanel()"></button>
                <!-- <img src="img/Logo_Nebulo2.png" alt="" class="card-img-top"> -->

                <div class="card-body">
                    <!-- Nom du capteur en haut -->
                    <!-- <h3 id="title_deviceName"></h3> -->
                    <button type="button" class="btn btn-outline-primary btn-lg disabled" id="title_deviceName"></button>
                    <h5 class="card-title" id="card-title"></h5>

                    <!--  Grafana iframe -->
                    <iframe id="chartSensor" src="about:blank" width="100%" height="400" frameborder="0"></iframe>
                    <div id="chartSensor2"></div>


                    <!-- <p class="card-text">
                        Some quick example text to build on the card title and make up the bulk of the
                        card's
                        content.
                    </p> -->
                    <div id="historique">Historique</div>
                    <span id="button1h"></span>
                    <span id="button3h"></span>
                    <span id="button24h"></span>
                    <span id="button48h"></span>
                    <span id="button1s"></span>
                    <span id="button1m"></span>
                    <span id="button1a"></span>
                    <div id="pdt">Pas de temps</div>
                    <span id="button2m"></span>
                    <span id="button15m"></span>
                    <span id="button60m"></span>
                    <span id="button1440m"></span>
                </div>
            </div>
        </div> 
    </div>

    <!-- <div id="capture"></div> -->

    <script>

        var date = new Date();
        const hour = date.getHours();
        const get_hour_minus1 = date.setHours(date.getHours() - 1);
        const hour_minus1 = new Date(get_hour_minus1);
        const hour0 = hour_minus1.getHours();
        const min = date.getMinutes();
        document.querySelector("#button_horloge").innerHTML = hour + ":" + (min < 10 ? '0' : '') + min;  //2min par défaut
        //document.querySelector("#button_horloge").innerHTML = hour0 + ":" + "00" + " à " + hour + ":" + "00"; 

        var compoundUpper = "PM25";
        var timespanLower = 2;
        var timeLength = 3;

        let coordsCenter = [43.29490421, 5.37188392];
        let zoomLevel = 15;

        //on crée la carte, centrée sur Marseille
        var map = L.map('map', {
            zoomControl: false,
            renderer: L.canvas()
        });

                // ON ne fetch pas tout
        var apiFetchNebuleAir = {
        "data": [],
        "timespan": null,
        "timestamp": null
        };
        var apiFetchAtmoSudRef = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };
        var apiFetchAtmoSudMicro = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };
        var apiFetchSensorCommunity = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };

        var apiFetchPurpleAir = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };


        var root1;
        var root2;
        var root3;
        var root4; //chart in sidebar


        //on y ajoute la couche OSM
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 21
        }).addTo(map); 

        new L.Hash(map);

        if (location.hash) {
            const hash_params = location.hash.split("/");
            coordsCenter = [hash_params[1], hash_params[2]];
            zoomLevel = hash_params[0].substring(1);
        }

        map.setView(coordsCenter, zoomLevel);

        // var polygonPACA = L.geoJSON(paca,{fillOpacity:0.2, color:'black', weight:0, invert:true}).addTo(map);

        var nebuleairParticuliers = new L.layerGroup();
        var sensorCommunity = new L.layerGroup();
        var stationsRefAtmoSud = new L.layerGroup();
        var stationsMicroAtmoSud = new L.layerGroup();
        var modelisationPMAtmoSud = new L.layerGroup();
        var modelisationICAIRAtmoSud = new L.layerGroup();
        var purpleAir = new L.layerGroup();

        // Switch case
        // reload

        // ************************
        //Très important: on start la fonction "loadNebuleAir" une première fois avec document.ready
        $(document).ready(loadNebuleAir);
        // $(document).ready(loadSensorCommunity);
        //$(document).ready(loadStationRefAtmo);
        // $(document).ready(loadStationMicroAtmo);
        //$(document).ready(loadPurpleAir);
        //$(document).ready(openToast_loading);

        // ************************

        document.querySelector("#button_screenshot").addEventListener("click", screenShot);

        document.querySelector("#checkbox_micro_stationsParticuliers").checked = true;
        document.querySelector("#checkbox_sensor_community").checked = false;
        document.querySelector("#checkbox_stationsRefAtmoSud").checked = false;
        document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
        document.querySelector("#checkbox_modelisationPMAtmoSud").checked = false;
        document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked = false;
        document.querySelector("#checkbox_purpleAir").checked = false;

        if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
            map.addLayer(nebuleairParticuliers)
        }
        if (document.querySelector("#checkbox_sensor_community").checked) {
            map.addLayer(sensorCommunity)
        }
        if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            map.addLayer(stationsRefAtmoSud)
        }
        if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            map.addLayer(stationsMicroAtmoSud)
        }

        if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
            map.addLayer(modelisationPMAtmoSud)
        }

        if (document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked) {
            map.addLayer(modelisationICAIRAtmoSud)
        }

        if (document.querySelector("#checkbox_purpleAir").checked) {
            map.addLayer(purpleAir)
        }

        document.querySelector("#checkbox_micro_stationsParticuliers").addEventListener("change", switchNebuleAir)
        document.querySelector("#checkbox_sensor_community").addEventListener("change", switchSensorCommunity)
        document.querySelector("#checkbox_stationsRefAtmoSud").addEventListener("change", switchRefAtmo)
        document.querySelector("#checkbox_micro_stationsAtmoSud").addEventListener("change", switchMicroAtmo)
        document.querySelector("#checkbox_modelisationPMAtmoSud").addEventListener("change", switchModelisationPMAtmo)
        document.querySelector("#checkbox_modelisationICAIRAtmoSud").addEventListener("change", switchModelisationICAIRAtmo)
        document.querySelector("#checkbox_purpleAir").addEventListener("change", switchPurpleAir)

        function switchNebuleAir() {
            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {

                if (apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && apiFetchNebuleAir.timespan != timespanLower )) {
                        console.log("Reload NebuleAir!");
                        loadNebuleAir();
                    }else{
                        if (apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > timespanLower * 60 * 1000)) {
                    console.log("Reload NebuleAir!");
                    loadNebuleAir();
                }
            
            }
                map.addLayer(nebuleairParticuliers);

            } else {
                map.removeLayer(nebuleairParticuliers);
            }
        }

        function switchSensorCommunity() {

            if (timespanLower != 15) {
                if (document.querySelector("#checkbox_sensor_community").checked) {

                    if (apiFetchSensorCommunity.data.length == 0 || (apiFetchSensorCommunity.data.length != 0 && apiFetchSensorCommunity.timespan != timespanLower )) {
                        console.log("Reload Sensor.Community!");
                        loadSensorCommunity();
                    }else{
                    
                    if (apiFetchSensorCommunity.data.length == 0 || (apiFetchSensorCommunity.data.length != 0 && Date.now() - apiFetchSensorCommunity.timestamp > timespanLower * 60 * 1000)) {
                        console.log("Reload Sensor.Community!");
                        loadSensorCommunity();
                    }
                }
                    map.addLayer(sensorCommunity);
                } else {
                    map.removeLayer(sensorCommunity);
                }
            } else {
                openToast("Pas de moyenne quart-horaire pour les capteurs Sensor.Community");
                document.querySelector("#checkbox_sensor_community").checked = false;
            }

        }

        function switchRefAtmo() {

            if (timespanLower != 2) {
                if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) { //ATTENTION CAS 2mins
                    if (apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && apiFetchAtmoSudRef.timespan != timespanLower )) {
                        console.log("Reload AtmoSud Ref!");
                        loadStationRefAtmo();
                    }else{
                    
                    if (apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && apiFetchAtmoSudRef.timespan == timespanLower && Date.now() - apiFetchAtmoSudRef.timestamp > timespanLower * 60 * 1000)) {
                        console.log("Reload AtmoSud Ref!");
                        loadStationRefAtmo();
                    }
                }
                    map.addLayer(stationsRefAtmoSud);
                } else {
                    map.removeLayer(stationsRefAtmoSud);
                }
            } else {
                openToast("Pas de données à intervalle 2 minutes pour les stations de référence AtmoSud");
                document.querySelector("#checkbox_stationsRefAtmoSud").checked = false;
            }
        }

        function switchMicroAtmo() {

            if (timespanLower != 2 & timespanLower != 60 & timespanLower != 1440) {
                if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
                    if (apiFetchAtmoSudMicro.data.length == 0 || (apiFetchAtmoSudMicro.data.length != 0 && apiFetchAtmoSudMicro.timespan != timespanLower )) {
                        console.log("Reload AtmoSud Micro!");
                        loadStationMicroAtmo();
                    }else{

                    if (apiFetchAtmoSudMicro.data.length == 0 || (apiFetchAtmoSudMicro.data.length != 0 && Date.now() - apiFetchAtmoSudMicro.timestamp > timespanLower * 60 * 1000)) {
                        console.log("Reload AtmoSud Micro");
                        loadStationMicroAtmo();
                    }
                }
                    map.addLayer(stationsMicroAtmoSud);
                } else {
                    map.removeLayer(stationsMicroAtmoSud);
                }
            } else {
                openToast("Pas de données à intervalles 2 minutes, 1 heure ou 1 jour pour les microstations AtmoSud");
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
            }
        }

function switchModelisationPMAtmo() {
    if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
        loadModelisationPMAtmo();
          map.addLayer(modelisationPMAtmoSud);
                } else {
            map.removeLayer(modelisationPMAtmoSud);
                }
}

function switchModelisationICAIRAtmo() {
    if (document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked) {
        loadModelisationICAIRAtmo();
          map.addLayer(modelisationICAIRAtmoSud);
                } else {
            map.removeLayer(modelisationICAIRAtmoSud);
                }
}

function switchPurpleAir() {
            if (document.querySelector("#checkbox_purpleAir").checked) {

                if (apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && apiFetchPurpleAir.timespan != timespanLower )) {
                        console.log("Reload PurpleAir!");
                        loadPurpleAir();
                    }else{

                if (apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > timespanLower * 60 * 1000)) {
                    console.log("Reload PurpleAir!");
                    loadPurpleAir();
                }
            }
                map.addLayer(purpleAir);

            } else {
                map.removeLayer(purpleAir);
            }
        }

        document.querySelector("#button_PM1").addEventListener("click", choosePM1)
        document.querySelector("#button_PM25").addEventListener("click", choosePM25)
        document.querySelector("#button_PM10").addEventListener("click", choosePM10)

        function choosePM1() {
            document.querySelector("#button_PM10").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM25").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM1").classList.replace("btn-outline-primary", "btn-primary");
            compoundUpper = "PM1";
            document.querySelector("#div_button_seuils_PM10").style.visibility = "hidden";
            document.querySelector("#div_button_seuils_PM125").style.visibility = "visible";

            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }

            if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            stationsMicroAtmoSud.clearLayers();
            changeStationMicroAtmo();
            }

            if (document.querySelector("#checkbox_sensor_community").checked) {
                sensorCommunity.clearLayers();
                changeSensorCommunity();
            }

            if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            stationsRefAtmoSud.clearLayers();
            changeStationRefAtmo();
            }

            if (document.querySelector("#checkbox_purpleAir").checked) {
            purpleAir.clearLayers();
            changePurpleAir();
            }

            if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
                modelisationPMAtmoSud.clearLayers();
                loadModelisationPMAtmo();
                document.querySelector("#checkbox_modelisationPMAtmoSud").checked = false;
            }

        }

        function choosePM25() {
            document.querySelector("#button_PM10").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM25").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#button_PM1").classList.replace("btn-primary", "btn-outline-primary");
            compoundUpper = "PM25";
            document.querySelector("#div_button_seuils_PM10").style.visibility = "hidden";
            document.querySelector("#div_button_seuils_PM125").style.visibility = "visible";

            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }

            if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            stationsMicroAtmoSud.clearLayers();
            changeStationMicroAtmo();
            }

            if (document.querySelector("#checkbox_sensor_community").checked) {
                sensorCommunity.clearLayers();
                changeSensorCommunity();
            }

            if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            stationsRefAtmoSud.clearLayers();
            changeStationRefAtmo();
            }

            if (document.querySelector("#checkbox_purpleAir").checked) {
            purpleAir.clearLayers();
            changePurpleAir();
            }

            if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
                modelisationPMAtmoSud.clearLayers();
                loadModelisationPMAtmo();
            }
        }

        function choosePM10() {
            document.querySelector("#button_PM10").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#button_PM25").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM1").classList.replace("btn-primary", "btn-outline-primary");
            compoundUpper = "PM10";
            document.querySelector("#div_button_seuils_PM10").style.visibility = "visible";
            document.querySelector("#div_button_seuils_PM125").style.visibility = "hidden";

            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }

            if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            stationsMicroAtmoSud.clearLayers();
            changeStationMicroAtmo();
            }

            if (document.querySelector("#checkbox_sensor_community").checked) {
                sensorCommunity.clearLayers();
                changeSensorCommunity();
            }

            if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            stationsRefAtmoSud.clearLayers();
            changeStationRefAtmo();
            }

            if (document.querySelector("#checkbox_purpleAir").checked) {
            purpleAir.clearLayers();
            changePurpleAir();
            }
            
            if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
                modelisationPMAtmoSud.clearLayers();
                loadModelisationPMAtmo();
            }

        }

        document.querySelector("#btn_actuel").addEventListener("click", chooseActuel)
        document.querySelector("#btn_quartHoraire").addEventListener("click", choose15)
        document.querySelector("#btn_horaire").addEventListener("click", choose60)
        document.querySelector("#btn_journalier").addEventListener("click", choose1440)

        function chooseActuel() {
            document.querySelector("#btn_journalier").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-outline-primary", "btn-primary");
            timespanLower = 2;

        const date = new Date();
        const hour = date.getHours();
        const min = date.getMinutes();
        document.querySelector("#button_horloge").innerHTML = hour + ":" + (min < 10 ? '0' : '') + min;  //2min par 


        if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 2 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 2 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }
        
        if(document.querySelector("#checkbox_micro_stationsAtmoSud").checked){
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
                map.removeLayer(stationsMicroAtmoSud);
                openToast("Pas de données à intervalles 2 minutes pour les microstations AtmoSud");
            }

        if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
            document.querySelector("#checkbox_stationsRefAtmoSud").checked = false;
            map.removeLayer(stationsRefAtmoSud);
            openToast("Pas de données à intervalles 1 jour pour les stations de référence AtmoSud");
        }

        if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 2 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 2 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }

        }

        function choose15() {
            document.querySelector("#btn_journalier").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-primary", "btn-outline-primary");
            timespanLower = 15;

            const end = new Date();
            const hour2 = end.getHours();
            const min_ori2 = end.getMinutes();

            if (min_ori2 <= 15)
            {
               var  min2 = 0;
            }else if(min_ori2 > 15 && min_ori2 <=30)
            {
                var  min2 = 15;
            }else if(min_ori2 > 30 && min_ori2 <=45)
            {
                var  min2 = 30;
            }else
            {
                var min2 =45;

            }

            const get_start = end.setMinutes(end.getMinutes() - 15);
            const start = new Date(get_start);
            const hour1 = start.getHours();
            const min_ori1 = start.getMinutes();

            if (min_ori1 <= 15)
            {
               var  min1 = 0;
            }else if(min_ori1 > 15 && min_ori1 <=30)
            {
                var  min1 = 15;
            }else if(min_ori1 > 30 && min_ori1 <=45)
            {
                var  min1 = 30;
            }else
            {
                var min1 =45;

            }
        
            document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ;  


            if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 15 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 15 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }

            if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
            if (apiFetchAtmoSudRef.timespan != 15 || apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > 15 * 60 * 1000))
            {
                stationsRefAtmoSud.clearLayers();
                loadStationRefAtmo();
            }else{
                stationsRefAtmoSud.clearLayers();
                changeStationRefAtmo();
            }
            }

            if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 15 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 15 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }
        }

        function choose60() {
            document.querySelector("#btn_journalier").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-primary", "btn-outline-primary");
            timespanLower = 60;

            const end = new Date();
            const hour2 = end.getHours();
            const min2 = end.getMinutes();
            const get_start = end.setHours(end.getHours() - 1);
            const start = new Date(get_start);
            const hour1 = start.getHours();
            const min1 = start.getMinutes();
            // document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ; 
            document.querySelector("#button_horloge").innerHTML = hour1 + ":" + "00" + " à " + hour2 + ":" + "00"; 


            if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 60 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 60 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }
        
            if(document.querySelector("#checkbox_micro_stationsAtmoSud").checked){
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
                map.removeLayer(stationsMicroAtmoSud);
                openToast("Pas de données à intervalles 1 heure pour les microstations AtmoSud");
            }

            if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
            if (apiFetchAtmoSudRef.timespan != 60 || apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > 60 * 60 * 1000))
            {
                stationsRefAtmoSud.clearLayers();
                loadStationRefAtmo();
            }else{
                stationsRefAtmoSud.clearLayers();
                changeStationRefAtmo();
            }
            }

            if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 60 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 60 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }
        }

        function choose1440() {
            document.querySelector("#btn_journalier").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-primary", "btn-outline-primary");
            timespanLower = 1440;

            const date = new Date();
            const get_datemoins1 = date.setHours(date.getHours() - 24);
            const datemoins1 = new Date(get_datemoins1);
            const jour = datemoins1.getDate();
            const mois = datemoins1.getMonth() + 1;
            document.querySelector("#button_horloge").innerHTML = (jour < 10 ? '0' : '') + jour + "/" + (mois < 10 ? '0' : '') + mois;  //2min par défaut


            if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 1440 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 1440 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }


            if(document.querySelector("#checkbox_micro_stationsAtmoSud").checked){
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
                map.removeLayer(stationsMicroAtmoSud);
                openToast("Pas de données à intervalles 1 jour pour les microstations AtmoSud");
            }

            if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
                if (apiFetchAtmoSudRef.timespan != 1440 || apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > 1440 * 60 * 1000))
            {
                stationsRefAtmoSud.clearLayers();
                loadStationRefAtmo();
            }else{
                stationsRefAtmoSud.clearLayers();
                changeStationRefAtmo();
            }

            }

            if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 1440 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 15 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }

        }

        // //ouverture du toast
        // function openToast_loading() {
        //     const toastLiveExample = document.getElementById('loadToast')
        //     const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
        //     console.log("Showing loading toast");
        //     toastBootstrap.show()
        // }
        // //fermeture du toast
        // function closeToast_loading() {
        //     const toastLiveExample = document.getElementById('loadToast')
        //     const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
        //     console.log("Hiding loading toast");
        //     toastBootstrap.hide()
        // }

                //ouverture du toast
        function openToast(message) {
            let toastDiv= document.getElementById('messageToast');
            document.getElementById('message').innerText = message;
            let toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastDiv);
            console.log("Showing message toast");
            toastBootstrap.show()
        }
        //fermeture du toast
        function closeToast() {
            let toastDiv = document.getElementById('messageToast');
            let toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastDiv);
            console.log("Hiding messgae toast");
            toastBootstrap.hide()
        }

        //fonction qui ouvre le side panel
        function OpenSidePanel(sensor) {
            const targetDiv = document.getElementById("sidePanel");
            console.log(sensor);
            targetDiv.style.display = "block";
            document.getElementById("title_deviceName").innerHTML = sensor;

            switch(timespanLower) {
            case 2:
                var tempo = " à 2 minutes ";
                break;
            case 15:
                var tempo = " quart-horaires ";
                break;
            case 60:
                var tempo = " horaires ";
                break;
            case 1440:
                var tempo = " journalières ";
                break;
            } 

            document.getElementById("card-title").innerText = 'Evolution des concentrations' + tempo + 'en particules fines (µg/m3)';

           var timespanGraph = timespanLower;
           var timeLengthGraph = timeLength;

            if (sensor.includes("nebuleair")) {
                let id = sensor.split("-")[1];
                load1NebuleAir(id,timeLengthGraph,timespanGraph);
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',1,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',3,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',24,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',48,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',168,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',720,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',2)" class="btn btn-outline-secondary btn-sm">2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
               buttonsSwitcher(timeLengthGraph,timespanGraph);

               if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }

            if (sensor.includes("sensor.community")) {
                let id = sensor.split("-")[1];
                document.getElementById("chartSensor").style.display = 'block';
                document.getElementById("chartSensor2").style.display = 'none';
                document.getElementById("chartSensor").src = "https://api-rrd.madavi.de:3000/grafana/d-solo/000000004/single-sensor-view-for-map?orgId=1&var-node=" + id + "&panelId=2";
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\',1)" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 3)" class="btn btn-outline-secondary btn-sm" disabled>3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 24)" class="btn btn-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 48)" class="btn btn-outline-secondary btn-sm" disabled>48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 168)" class="btn btn-outline-secondary btn-sm" disabled>1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 720)" class="btn btn-outline-secondary btn-sm" disabled>1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm" disabled>1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-secondary btn-sm">2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>24h</button>';
            }

            if (sensor.includes("microstationAtmoSud")) {
                var id = sensor.split("-")[1];
                load1MicroAtmo(id,timeLength); 
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\',1)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 3)" class="btn btn-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 24)" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 48)" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 168)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 720)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm" disabled>1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" class="btn btn-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>24h</button>';
            }

            if (sensor.includes("stationRefAtmoSud")) {
                var id = sensor.split("-")[1];
                load1RefAtmo(id,timeLengthGraph,timespanGraph); 
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 1,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 3,' + timespanGraph + ')" class="btn btn-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 24,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 48,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 168,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 720),' + timespanGraph + '" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLengthGraph + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLengthGraph + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLengthGraph + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
                buttonsSwitcher(timeLengthGraph,timespanGraph);
                
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }

            if (sensor.includes("purpleair")) {
                let id = sensor.split("-")[1];
                load1PurpleAir(id,timeLengthGraph,timespanGraph);
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',1,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',3,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',24,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',48,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',168,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',720,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',2)" class="btn btn-outline-secondary btn-sm">2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
               buttonsSwitcher(timeLengthGraph,timespanGraph);

               if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }
        }

        function chooseTimeSensorCommunity(sensor, hours) {
            document.getElementById("chartSensor").src = "https://api-rrd.madavi.de:3000/grafana/d-solo/000000004/single-sensor-view-for-map?orgId=1&var-node=" + sensor + "&panelId=2";
            if (hours == 24) {
                document.getElementById("button24h").classList.replace("btn-outline-secondary", "btn-secondary");
            }

            //A COMPLETER
        }

        function chooseTimeNebuleAir(sensor, hours, timespan) {
            timeLengthGraph = hours;
            timespanGraph = timespan;
            console.log(sensor);
            console.log(hours);
            console.log(timespan);
            load1NebuleAir(sensor,timeLengthGraph,timespanGraph);
            document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',1,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',3,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">3h</button>';
            document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',24,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
            document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',48,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
            document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',168,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
            document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',720,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 mois</button>';
            document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
            document.getElementById("button2m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',2)" class="btn btn-outline-secondary btn-sm">2m</button>';
            document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
            document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
            buttonsSwitcher(timeLengthGraph,timespanGraph);
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
        }
                //changer la couleur du bouton en fonction du choix (not working?)
        function chooseTimeAtmoMicro(sensor, hours) {
            console.log(sensor);
            console.log(hours);
            load1MicroAtmo(sensor,hours)
            buttonsSwitcher(hours);
        }


        function chooseTimeAtmoRef(sensor, hours, timespan) {
            timeLengthGraph = hours;
            timespanGraph = timespan;
            console.log(sensor);
            console.log(hours);
            console.log(timespan);
            load1RefAtmo(sensor,timeLengthGraph,timespanGraph);
            document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',1,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 3,' + timespanGraph + ')" class="btn btn-secondary btn-sm">3h</button>';
            document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 24,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
            document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 48,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
            document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 168,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
            document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 720,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 mois</button>';
            document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
            document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
            document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
            document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
            buttonsSwitcher(timeLengthGraph,timespanGraph);
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }


        //fonction qui ferme le side panel
        function CloseSidePanel() {
            const targetDiv = document.getElementById("sidePanel");
            targetDiv.style.display = "none";
        }


function buttonsSwitcher(hours,timespan){
    console.log(hours);
    console.log(timespan);
    switch (hours) {
            case 1:
                document.getElementById("button1h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 3:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 24:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 48:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 168:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 720:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                break;
            }

            switch (timespan) {
            case 2:
                document.getElementById("button2m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 15:
                document.getElementById("button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 60:
                document.getElementById("button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 1440:
                document.getElementById("button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                break;
            }
}

function screenShot() {
            console.log("Screenshot!");


    html2canvas(document.body,{
        logging: false,
        useCORS:true  //REVOIR LES OPTIONS
    }).then(function(canvas) {
        canvas.toBlob(function(blob) {
            window.saveAs(blob, "screenshot.png");
        });
    });


    // html2canvas(document.body,{
    //     onrendered: function(canvas){

    //         canvas.toBlob(function(blob) {
    //         window.saveAs(blob, "screenshot.png");
    //     });

    //     }
    // });

    // html2canvas(document.body).then(function(canvas) {
  	// var link =  document.createElement("a");
    // link.setAttribute('download', 'MintyPaper.png');
    // link.setAttribute('href', canvas.toDataURL("image/png").replace("image/png", "image/octet-stream"));
    // link.click();
	// });

}


function timeDateCounter(timestamp){

const timestamp_UTC = new Date(timestamp);
const now = Date.now();

let difference = Math.floor((now - timestamp_UTC)/86400000);

var date_texte ="";
let horaire_texte="";

switch(difference) {
  case 0:
    date_texte = "aujourd'hui";
    break;
  case 1:
    date_texte = "hier";
    break;
  case 2:
    date_texte = "avant-hier";
    break;
  default:
    date_texte += "le ";
    if(timestamp_UTC.getDate()< 10){
    date_texte += "0";
    date_texte += timestamp_UTC.getDate();
  }else{
    date_texte += timestamp_UTC.getDate();
  }
  date_texte += "/";
  if((timestamp_UTC.getMonth()+1)< 10){
    date_texte += "0";
    date_texte += (timestamp_UTC.getMonth()+1);
  }else{
    date_texte += (timestamp_UTC.getMonth()+1);
  }
  date_texte += "/";
  date_texte += timestamp_UTC.getFullYear();
} 

//horaire
if(timestamp_UTC.getHours()< 10){
horaire_texte += "0";
horaire_texte += timestamp_UTC.getHours();
}else{
horaire_texte += timestamp_UTC.getHours();
}
horaire_texte += "h";
if(timestamp_UTC.getMinutes()< 10){
horaire_texte += "0";
horaire_texte += timestamp_UTC.getMinutes();
}else{
horaire_texte += timestamp_UTC.getMinutes();
} 

return date_texte + " à " + horaire_texte;
}
        setInterval(function() {
            console.log("Setinterval:");
            console.log(timespanLower * 60 * 1000);
            console.log(Date.now() - apiFetchNebuleAir.timestamp);

        if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
            if (apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > timespanLower * 60 * 1000 - 1000)) {
                    loadNebuleAir();
                    openToast("Données NebuleAir rechargées");
                }
        }

        if (document.querySelector("#checkbox_sensor_community").checked) {
            if (apiFetchSensorCommunity.data.length == 0 || (apiFetchSensorCommunity.data.length != 0 && Date.now() - apiFetchSensorCommunity.timestamp > timespanLower * 60 * 1000 - 1000)) {
                    loadSensorCommunity();
                    openToast("Données Sensor.Community rechargées");
                }
        }

        if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            if (apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > timespanLower * 60 * 1000 - 1000)) {
                    loadStationRefAtmo();
                    openToast("Données Atmo sations de reférence rechargées");
                }
        }

        if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            if (apiFetchAtmoSudMicro.data.length == 0 || (apiFetchAtmoSudMicro.data.length != 0 && Date.now() - apiFetchAtmoSudMicro.timestamp > timespanLower * 60 * 1000 - 1000)) {
                    loadStationMicroAtmo();
                    openToast("Données Atmo microstations rechargées");
                }
        }

        if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked && timespanLower == 60) {
            loadModelisationPMAtmo();
            openToast("Modélisation Atmo PM rechargée");
        }

        if (document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked && timespanLower == 60) {
            loadModelisationICAIRAtmo();
            openToast("Modélisation Atmo ICAIR rechargée");
        }

        if (document.querySelector("#checkbox_purpleAir").checked) {
            if (apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > timespanLower * 60 * 1000 - 1000)) {
                    loadPurpleAir();
                    openToast("Données PurpleAir rechargées");
                }
        }

        }, timespanLower * 60 * 1000)


    </script>

    <!-- Bootstrap 5.3.0 -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    <script>
        var tooltipTriggerList = [].slice.call(
            document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
</body>

</html>