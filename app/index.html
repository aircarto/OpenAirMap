<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="https://aircarto.fr/images/favicon.ico" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script> -->



    <!-- AJAX -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
    <!-- Bootstrap 5.3.0 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Cookies -->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

    <!-- my files -->
    <script src="js_scripts/NebuleAir.js"></script>
    <script src="js_scripts/purpleAir.js"></script>
    <script src="js_scripts/AtmoSudRef.js"></script>
    <script src="js_scripts/AtmoSudMicro.js"></script>
    <script src="js_scripts/sensorCommunity.js"></script>
    <script src="js_scripts/AtmoSudModelisation.js"></script>
    <script src="js_scripts/api_purpleair.js"></script>
    <script src="js_scripts/leaflet-velocity.min.js"></script>
    <script src="js_scripts/config.js"></script>

    <script src="geojson/paca.geojson"></script>


    <!-- style CSS  -->
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/leaflet-velocity.min.css">


    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/plugins/exporting.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-hash/0.2.1/leaflet-hash.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <!-- <script src="https://cdn.rawgit.com/hayeswise/Leaflet.PointInPolygon/v1.0.0/wise-leaflet-pip.js"></script> -->
    
    <script src="https://cdn.jsdelivr.net/npm/leaflet.snogylop@0.4.0/src/leaflet.snogylop.min.js"></script>

    <title>Open Air Map</title>
</head>

<body>

    <script>
        HTMLCanvasElement.prototype.getContext = function(origFn) {
          return function(type, attribs) {
            attribs = attribs || {};
            attribs.preserveDrawingBuffer = true;
            return origFn.call(this, type, attribs);
          };
        }(HTMLCanvasElement.prototype.getContext);
        </script>

    <!-- LA CARTE -->
    <div id="map"></div>

    <!-- Toast de chargement des données -->
    <!-- <div class="toast-container position-fixed end-0 p-3" style="bottom:10px;">
        <div class="toast align-items-center" id="loadToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Chargement des données <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </div> -->
                <!-- <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button> -->
            <!-- </div>
        </div>
    </div> -->

       <!-- Toast de chargement des données -->
       <div class="toast-container position-fixed end-0 p-3" style="bottom:10px;">
        <div class="toast align-items-center text-bg-danger border-0" id="messageToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    Attention: <span id="message"></span>
                </div>
            </div>
        </div>
    </div>




    <!-- Boutons PM1 PM2.5 PM10 -->
    <div class="btn-group" id="div_buttonPM" role="group">
        <button id="button_PM1" class="btn btn-outline-primary">PM1</button>
        <button id="button_PM25" class="btn btn-outline-primary">PM2.5</button>
        <button id="button_PM10" class="btn btn-outline-primary">PM10</button>
    </div>

    <!-- Bouton Plus d'infos -->
    <button type="button" class="btn btn-primary" id="button_openWelcomeModal" onclick="openWelcomeModal()"><i class="bi bi-info-circle"></i></button>

    <!-- Bouton dropdown Choix des capteurs -->
    <div class="dropdown" id="div_checkbox_choixCapteur">
        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
            Source des données
        </button>
        <ul class="dropdown-menu">
            <li><input type="checkbox" id="checkbox_micro_stationsParticuliers" name="checkbox_micro_stationsParticuliers" /><label for="checkbox_micro_stationsParticuliers">&ensp;Capteurs NebuleAir</label></li>
            <li><input type="checkbox" id="checkbox_sensor_community" name="checkbox_sensor_community" /><label for="checkbox_sensor_community"></label>&ensp;Capteurs Sensor.Community</label></li>
            <li><input type="checkbox" id="checkbox_purpleAir" name="checkbox_purpleAir" /><label for="checkbox_purpleAir">&ensp;Capteurs PurpleAir</label></li>
            <li><input type="checkbox" id="checkbox_micro_stationsAtmoSud" name="checkbox_micro_stationsAtmoSud" disabled/><label for="checkbox_micro_stationsAtmoSud">&ensp;Micro-stations AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_stationsRefAtmoSud" name="checkbox_stationsRefAtmoSud" /><label for="checkbox_stationsRefAtmoSud">&ensp;Stations de Référence AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_modelisationPMAtmoSud" name="checkbox_modelisationPMAtmoSud" /><label for="checkbox_modelisationPMAtmoSud">&ensp;Modélisation horaire PM AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_modelisationICAIRAtmoSud" name="checkbox_modelisationICAIRAtmoSud" /><label for="checkbox_modelisationICAIRAtmoSud">&ensp;Modélisation horaire ICAIRh AtmoSud</label></li>
            <li><input type="checkbox" id="checkbox_wind" name="checkbox_wind" /><label for="checkbox_wind">&ensp;Vents</label></li>
        </ul>
    </div>

        <!-- Logos -->
    <div id="div_logos">
        <img
        src="./img/LogoAirCarto.png"
        class="float-right"
        height="25"
        alt=""
      />
      <img
      src="./img/LogoAtmoSud.png"
      class="float-left"
      height="25"
      alt=""
    />
    </div>

    <!-- Seuils PM -->
    <div class="btn-group" id="div_button_seuils_PM125" role="group">
        <button class="btn" id="btn_default" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="pas de donnée pour ce type de particule / ce pas de temps">Pas de donnée</button>
        <button class="btn" id="btn_bon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="0 à 10 &#181;g/m&#179;">Bon</button>
        <button class="btn" id="btn_moyen" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="11 à 20 &#181;g/m&#179;">Moyen</button>
        <button class="btn" id="btn_degrade" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="21 à 25 &#181;g/m&#179;">Dégradé</button>
        <button class="btn" id="btn_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="26 à 50 &#181;g/m&#179;">Mauvais</button>
        <button class="btn" id="btn_tres_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="51 à 75 &#181;g/m&#179;">Très Mauvais</button>
        <button class="btn" id="btn_extr_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title=">75 &#181;g/m&#179;">Extr. Mauvais</button>
    </div>

    <div class="btn-group" id="div_button_seuils_PM10" role="group">
        <button class="btn" id="btn_default" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="pas de donnée pour ce type de particule / ce pas de temps">Pas de donnée</button>
        <button class="btn" id="btn_bon" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="0 à 20 &#181;g/m&#179;">Bon</button>
        <button class="btn" id="btn_moyen" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="21 à 40 &#181;g/m&#179;">Moyen</button>
        <button class="btn" id="btn_degrade" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="41 à 50 &#181;g/m&#179;">Dégradé</button>
        <button class="btn" id="btn_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="51 à 100 &#181;g/m&#179;">Mauvais</button>
        <button class="btn" id="btn_tres_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="101 à 150 &#181;g/m&#179;">Très Mauvais</button>
        <button class="btn" id="btn_extr_mauvais" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title=">150 &#181;g/m&#179;">Extr. Mauvais</button>
    </div>

    <!-- Boutons pas de temps -->
    <div class="btn-group" id="div_button_pas_de_temps" role="group">
        <button class="btn btn-outline-primary" id="btn_actuel">2 minutes</button>
        <button class="btn btn-outline-primary" id="btn_quartHoraire">Quart-horaire</button>
        <button class="btn btn-outline-primary" id="btn_horaire">Horaire</button>
        <button class="btn btn-outline-primary" id="btn_journalier">Journalier</button>
    </div>

    <button type="button" class="btn btn-outline-primary" id="button_horloge"></button>

    <button type="button" class="btn btn-primary" id="button_screenshot">Faire une photo</button>


    <!-- Les Logos -->
    <!-- <div id="logoAirCarto"><a href="https://aircarto.fr/"><img src="img/logoAirCarto.png" alt=""></a></div> -->

    <!-- LE SIDE PANEL avec les graphiques (id "sidePanel") POUR DESKTOP -->
    <div class="row text-center">
        <div class="col-5" id="sidePanelCol">
            <div class="card m-3" id="sidePanel" style="display: none;">
                <!-- Bouton pour fermer le panel -->
                <button type="button" class="btn-close position-absolute top-0 end-0" aria-label="Close" style="margin: 5px ;" onclick="CloseSidePanel()"></button>
                <!-- <img src="img/Logo_Nebulo2.png" alt="" class="card-img-top"> -->
                <span onclick="fullScreen()">
                    <i class="bi bi-aspect-ratio position-absolute bottom-0 end-0 me-1"></i>
                </span>
                <div class="card-body">
                    <!-- Nom du capteur en haut -->
                    <!-- <h3 id="title_deviceName"></h3> -->
                    <button type="button" class="btn btn-outline-primary btn-lg disabled" id="title_deviceName"></button>
                    <h5 class="card-title" id="card-title"></h5>

                    <!--  Grafana iframe -->
                    <iframe id="chartSensor" src="about:blank" width="100%" height="400" frameborder="0"></iframe>
                    <div id="chartSensor2"></div>


                    <!-- <p class="card-text">
                        Some quick example text to build on the card title and make up the bulk of the
                        card's
                        content.
                    </p> -->
                    <div id="historique">Historique</div>
                    <span id="button1h"></span>
                    <span id="button3h"></span>
                    <span id="button24h"></span>
                    <span id="button48h"></span>
                    <span id="button1s"></span>
                    <span id="button1m"></span>
                    <span id="button1a"></span>
                    <div id="pdt">Pas de temps</div>
                    <span id="button2m"></span>
                    <span id="button15m"></span>
                    <span id="button60m"></span>
                    <span id="button1440m"></span>
                </div>
            </div>
        </div> 
    </div>

      <!-- Modal General Infos -->
      <div class="modal fade" id="welcome_Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Welcome to OpenAirMap</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row justify-content-md-center mb-2">
                      <div class="col-lg-4"><img src="img/LogoAirCarto.png" class="img-fluid" alt="..."></div>
                      <div class="col-lg-4"><img src="img/LogoAtmoSud.png" class="img-fluid" alt="..."></div>
                    </div>
                    <div class="row">
                        <p>
                        L'application OpenAirMap est un projet open source porté par AirCarto et AtmoSud pour afficher en temps réel les mesures de qualité de l'air effectué par
            les stations de mesures et les micro-capteurs. Les informations affichées sur la carte sont récupérées via différentes plateforme de mise à disposition de données de mesure (API). 
            A noter que cette application est en constante évolution et amélioration. Pour toutes questions et suggestions n'hésitez pas à déposer un message sur le <a href="https://github.com/aircarto/OpenAirMap" >GitHub du projet</a>.
            <br><br>
            <h5>Liste des données proposées par OpenAirMap</h5>
            A noter que pour certains appareils, la donnée n'est pas disponible pour tous les pas de temps (2 minutes, quart-horaire, horaire et journalier).
            <div class="table-responsive">

                <table class="table">
                    <thead>
                    <tr>
                        <th scope="col"></th>
                        <th scope="col">Type de mesure</th>
                        <th scope="col">Icône</th>
                        <th scope="col">Pas de temps</th>
                        <th scope="col">Description</th>
                        <th scope="col" class="text-end">Lien vers API</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <th scope="row">Capteurs NebuleAir</th>
                        <td><span class="badge rounded-pill text-bg-info">micro-capteur</span></td>
                        <td><img src="img/nebuleAir/nebuleAir_moyen.png" alt="" style="width: 30px;"></td>
                        <td><div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-success btn-sm">2m</button>
                            <button type="button" class="btn btn-success btn-sm">QH</button>
                            <button type="button" class="btn btn-success btn-sm">H</button>
                            <button type="button" class="btn btn-success btn-sm">J</button>
                          </div>
                        </td>
                        <td>Micro-capteurs open source co-développés par AirCarto et AtmoSud</td>
                        <td class="text-end align-middle"><a class="btn btn-primary" href="https://aircarto.fr/API_V2/" role="button">AirCarto</a></td>
                    </tr>
                    <tr>
                        <th scope="row">Capteurs Sensor.Community</th>
                        <td><span class="badge rounded-pill text-bg-info">micro-capteur</span></td>
                        <td><img src="img/purpleAir/purpleAir_moyen.png" alt="" style="width: 30px;"></td>
                        <td><div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-success btn-sm">2m</button>
                            <button type="button" class="btn btn-danger btn-sm">QH</button>
                            <button type="button" class="btn btn-danger btn-sm">H</button>
                            <button type="button" class="btn btn-danger btn-sm">J</button>
                          </div>
                        </td>
                        <td>Micro-capteurs open source fabriqués par des citoyens bénévoles </td>
                        <td class="text-end align-middle"><a class="btn btn-primary" href="https://sensor.community/fr/" role="button">Sensor.Community</a></td>

                    </tr>
                    <tr>
                        <th scope="row">Capteurs PurpleAir</th>
                        <td><span class="badge rounded-pill text-bg-info">micro-capteur</span></td>
                        <td><img src="img/SensorCommunity/SensorCommunity_moyen.png" alt="" style="width: 30px;"></td>
                        <td><div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-success btn-sm">2m</button>
                            <button type="button" class="btn btn-danger btn-sm">QH</button>
                            <button type="button" class="btn btn-danger btn-sm">H</button>
                            <button type="button" class="btn btn-danger btn-sm">J</button>
                          </div>
                        </td>
                        <td>Micro-capteurs commercialisés par l'entreprise américaine PurpleAir Inc.</td>
                        <td class="text-end align-middle"><a class="btn btn-primary" href="https://api.purpleair.com/" role="button">PurpleAir</a></td>
                    </tr>
                    <tr>
                        <th scope="row">Micro-stations AtmoSud</th>
                        <td><span class="badge rounded-pill text-bg-info">micro-capteur</span></td>
                        <td><img src="img/microStationsAtmoSud/microStationAtmoSud_moyen.png" alt="" style="width: 30px;"></td>
                        <td><div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-danger btn-sm">2m</button>
                            <button type="button" class="btn btn-success btn-sm">QH</button>
                            <button type="button" class="btn btn-danger btn-sm">H</button>
                            <button type="button" class="btn btn-danger btn-sm">J</button>
                          </div>
                        </td>
                        <td>Micro-capteurs déployés par AtmoSud</td>
                        <td rowspan="4" class="text-end align-middle"><a class="btn btn-primary" href="https://api.atmosud.org/" role="button">AtmoSud</a></td>
                    </tr>
                    <tr>
                        <th scope="row">Stations de référence AtmoSud</th>
                        <td><span class="badge rounded-pill text-bg-dark">station</span></td>
                        <td><img src="img/refStationsAtmoSud/refStationAtmoSud_moyen.png" alt="" style="width: 30px;"></td>
                        <td><div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-danger btn-sm">2m</button>
                            <button type="button" class="btn btn-success btn-sm">QH</button>
                            <button type="button" class="btn btn-success btn-sm">H</button>
                            <button type="button" class="btn btn-success btn-sm">J</button>
                          </div>
                        </td>
                        <td>Stations de référence installées dans le cadre de la mission de surveillance de la qualité de l'air d'AtmoSud</td>
                    
                    </tr>
                    <tr>
                        <th scope="row">Modélisation Horaire PM AtmoSud</th>
                        <td><span class="badge rounded-pill text-bg-secondary">modélisation</span></td>
                        <td></td>
                        <td><div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-danger btn-sm">2m</button>
                            <button type="button" class="btn btn-danger btn-sm">QH</button>
                            <button type="button" class="btn btn-success btn-sm">H</button>
                            <button type="button" class="btn btn-danger btn-sm">J</button>
                          </div>
                        </td>
                        <td>Modélisation des particules fines à l'échelle horaire sur toute la région PACA</td>
                        
                    </tr>
                    <tr>
                        <th scope="row">Modélisation Horaire ICAIRH AtmoSud</th>
                        <td><span class="badge rounded-pill text-bg-secondary">modélisation</span></td>
                        <td></td>
                        <td><div class="btn-group" role="group" aria-label="Basic mixed styles example">
                            <button type="button" class="btn btn-danger btn-sm">2m</button>
                            <button type="button" class="btn btn-danger btn-sm">QH</button>
                            <button type="button" class="btn btn-success btn-sm">H</button>
                            <button type="button" class="btn btn-danger btn-sm">J</button>
                          </div>
                        </td>
                        <td>Modélisation de l'indice cumulé de la qualité de l'air (NO2, O3, PM2.5 et PM10) à l'échelle horaire sur toute la région PACA.</td>
                        
                    </tr>
                    
                    
                    </tbody>
                </table>
            </div>
        </p>

                    </div>
                </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continuer</button>
            </div>
        </div>
        </div>
    </div>

    <!-- Modal screen too smalll -->
    <div class="modal fade" id="screen_tooSmall_Modal" tabindex="-1" aria-labelledby="exampleModalLabel2" aria-hidden="true">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel2">Attention</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            L'application OpenAirMap n'est pas encore optimisée pour être consultée sur un smartphone.
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">D'accord</button>
            </div>
        </div>
        </div>
    </div>

    <div class="modal fade" id="sensorPanel_Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
            <button id="button_close" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="container-fluid">
            <div class="row justify-content-md-center mb-2">
            <div class="col-lg-4"><img id="modal_logo" src="" class="img-fluid" alt="..."></div>
            <button class="btn btn-outline-primary" style="margin-right:5px;" id="modal_sensorid"></button>
            </div>
            </div>
            </div>
            <div id="modal_body" class="modal-body">
            <div class="container-fluid">
            <div class="row justify-content-md-center mb-2">
            <div id="modal_chartdivmodalgauge"></div>
            <iframe id="modal_chartSensor" src="about:blank" width="100%" height="200" frameborder="0"></iframe>
            <div id="modal_chartSensor2"></div>
            </div>
            <div id="modal_historique">Historique</div>
            <span id="modal_button1h"></span>
            <span id="modal_button3h"></span>
            <span id="modal_button24h"></span>
            <span id="modal_button48h"></span>
            <span id="modal_button1s"></span>
            <span id="modal_button1m"></span>
            <span id="modal_button1a"></span>
            <div id="modal_pdt">Pas de temps</div>
            <span id="modal_button2m"></span>
            <span id="modal_button15m"></span>
            <span id="modal_button60m"></span>
            <span id="modal_button1440m"></span>
            </div>
            </div>
            <div class="modal-footer">
                <div class="container-fluid">
                    <div class="row justify-content-md-center mb-2">
                <span id="modal_lastseen"></span>
                <span id="modal_wifilevel"></span>
            </div>
            </div>
            </div>
            </div>'
    </div>
    </div>
    
    <div class="modal fade" id="sensorPanel_Modal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                <button id="button_close" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <div class="container-fluid">
                <div class="row justify-content-md-center mb-2">
                <div class="col-lg-4"><img id="modal2_logo" src="img/LogoAtmoSud.png" class="img-fluid" alt="..."></div>
                <button class="btn btn-outline-primary" style="margin-right:5px;" id="modal2_sensorid"></button>
                </div>
                </div>
                </div>
                <div id="modal2_body" class="modal-body">
                <div class="container-fluid">
                <div id="modal2_list" class="row justify-content-md-center mb-2">
                </div>
                </div>
                </div>
                </div>'
        </div>
        </div>

    <!-- <div id="capture"></div> -->

    <script>

        // const isMobile = navigator.userAgentData.mobile;
        const isMobile = mobileTest();
        
function mobileTest() {
  let check = false;
  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
  return check;
};
        //const isMobile = true;
        //const isMobile = false;
        console.log("Mobile: " + isMobile);

        //document.querySelector("#button_horloge").innerHTML = hour0 + ":" + "00" + " à " + hour + ":" + "00"; 


        switch(options.timespanLower) {
        case 2:
            var date = new Date();
            var hour = date.getHours();
            var get_hour_minus1 = date.setHours(date.getHours() - 1);
            var hour_minus1 = new Date(get_hour_minus1);
            var hour0 = hour_minus1.getHours();
            var min = date.getMinutes();
            document.querySelector("#button_horloge").innerHTML = hour + ":" + (min < 10 ? '0' : '') + min;  //2min par défaut
            break;
        case 15:
        var get_start = end.setMinutes(end.getMinutes() - 15);
        var start = new Date(get_start);
        var hour1 = start.getHours();
        var min_ori1 = start.getMinutes();
        if (min_ori1 <= 15)
        {
            var  min1 = 0;
        }else if(min_ori1 > 15 && min_ori1 <=30)
        {
            var  min1 = 15;
        }else if(min_ori1 > 30 && min_ori1 <=45)
        {
            var  min1 = 30;
        }else
        {
            var min1 =45;
        }
    
        document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ;
            break;
        case 60:
        var end = new Date();
        var hour2 = end.getHours();
        var min2 = end.getMinutes();
        var get_start = end.setHours(end.getHours() - 1);
        var start = new Date(get_start);
        var hour1 = start.getHours();
        var min1 = start.getMinutes();
            // document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ; 
            document.querySelector("#button_horloge").innerHTML = hour1 + ":" + "00" + " à " + hour2 + ":" + "00"; 
            break;
        case 1440:
        var date = new Date();
        var get_datemoins1 = date.setHours(date.getHours() - 24);
        var datemoins1 = new Date(get_datemoins1);
        var jour = datemoins1.getDate();
        var mois = datemoins1.getMonth() + 1;
            document.querySelector("#button_horloge").innerHTML = (jour < 10 ? '0' : '') + jour + "/" + (mois < 10 ? '0' : '') + mois;
            break;
        } 

        var root1;
        var root2;
        var root3;
        var root4; //chart in sidebar

        var apiFetchNebuleAir = {
        "data": [],
        "timespan": null,
        "timestamp": null
        };
        var apiFetchAtmoSudRef = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };
        var apiFetchAtmoSudRefList = [];
        var apiFetchAtmoSudMicro = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };
        var apiFetchSensorCommunity = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };
        var apiFetchPurpleAir = {
            "data": [],
            "timespan": null,
            "timestamp": null
        };

        let coordsCenter = options.coordsCenter;
        let zoomLevel = options.zoomLevel;

        //on crée la carte, centrée sur Marseille
        var map = L.map('map', {
            zoomControl: true,
            minZoom:options.minZoom,
            maxZoom: options.maxZoom,
            renderer: L.canvas(),
            maxBounds: L.latLngBounds(options.boundNE,options.boundSW)
        });


        //on y ajoute la couche OSM
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
        }).addTo(map); 


        map.once('locationfound', function(ev){
   console.log(ev.latlng);
});

if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(goToPosition,notAllowed);
  } else {
    map.setView(coordsCenter, zoomLevel);
  }

  function goToPosition(position) {
  map.setView([position.coords.latitude,position.coords.longitude], zoomLevel);
}

function notAllowed(err) {
    openToast("Vous n'avez pas autorisé la détection de la position.");  //Produit erreur ?
    map.setView(coordsCenter, zoomLevel);
}
    const query = {
	conentration: options.selection,
    minutes:options.timespanLower,
    affichage:options.display
    };


// jQuery.extend({

// getQueryParameters : function() {
//     return (document.location.search).replace(/(^\?)/,'').split("&").map(function(n){return n = n.split("="),this[n[0]] = n[1],this}.bind({}))[0];
// }

// });

// var queryParams = $.getQueryParameters();
// console.log(queryParams);



(function () {
	let telem;
    try {
	const search_values = location.search.split('?')[1].split('&');
    console.log(location.search);
    console.log(search_values);
	for (let i = 0; i < search_values.length; i++) {
		telem = search_values[i].split('=');
		query[telem[0]] = '';
		if (typeof telem[1] != 'undefined') query[telem[0]] = telem[1];
	}


switch (query.minutes) {
  case "2":
  options.timespanLower = 2;
    break;
  case "15":
  options.timespanLower = 15;
    break;
  case "60":
  options.timespanLower = 60;
    break;
 case "1440":
 options.timespanLower = 1440;
    break;
}

switch(options.timespanLower) {
        case 2:
            var date = new Date();
            var hour = date.getHours();
            var get_hour_minus1 = date.setHours(date.getHours() - 1);
            var hour_minus1 = new Date(get_hour_minus1);
            var hour0 = hour_minus1.getHours();
            var min = date.getMinutes();
            document.querySelector("#button_horloge").innerHTML = hour + ":" + (min < 10 ? '0' : '') + min;  //2min par défaut
            break;
        case 15:
        var get_start = end.setMinutes(end.getMinutes() - 15);
        var start = new Date(get_start);
        var hour1 = start.getHours();
        var min_ori1 = start.getMinutes();
        if (min_ori1 <= 15)
        {
            var  min1 = 0;
        }else if(min_ori1 > 15 && min_ori1 <=30)
        {
            var  min1 = 15;
        }else if(min_ori1 > 30 && min_ori1 <=45)
        {
            var  min1 = 30;
        }else
        {
            var min1 =45;
        }
    
        document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ;
            break;
        case 60:
        var end = new Date();
        var hour2 = end.getHours();
        var min2 = end.getMinutes();
        var get_start = end.setHours(end.getHours() - 1);
        var start = new Date(get_start);
        var hour1 = start.getHours();
        var min1 = start.getMinutes();
            // document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ; 
            document.querySelector("#button_horloge").innerHTML = hour1 + ":" + "00" + " à " + hour2 + ":" + "00"; 
            break;
        case 1440:
        var date = new Date();
        var get_datemoins1 = date.setHours(date.getHours() - 24);
        var datemoins1 = new Date(get_datemoins1);
        var jour = datemoins1.getDate();
        var mois = datemoins1.getMonth() + 1;
            document.querySelector("#button_horloge").innerHTML = (jour < 10 ? '0' : '') + jour + "/" + (mois < 10 ? '0' : '') + mois;
            break;
        } 

switch (query.concentration) {
  case 'PM1':
  options.compoundUpper = "PM1";
    break;
  case 'PM25':
  options.compoundUpper = "PM25";
    break;
  case 'PM10':
  options.compoundUpper = "PM10";
    break;
}

if (query.affichage.includes("nebuleair")){
$(document).ready(loadNebuleAir);
document.querySelector("#checkbox_micro_stationsParticuliers").checked = true;
}

if (query.affichage.includes("sensorcommunity")){
$(document).ready(loadSensorCommunity);
document.querySelector("#checkbox_sensor_community").checked = true;
}

if (query.affichage.includes("purpleair")){
$(document).ready(loadPurpleAir);
document.querySelector("#checkbox_purpleAir").checked = true;
}

if (query.affichage.includes("atmosudmicro")){
$(document).ready(loadStationMicroAtmo);
document.querySelector("#checkbox_micro_stationsAtmoSud").checked = true;
}

if (query.affichage.includes("atmosudref")){
$(document).ready(loadStationRefAtmo);
document.querySelector("#checkbox_stationsRefAtmoSud").checked = true;
}

        // // document.querySelector("#checkbox_micro_stationsParticuliers").checked = false;
        // document.querySelector("#checkbox_sensor_community").checked = false;
        // document.querySelector("#checkbox_stationsRefAtmoSud").checked = false;
        // document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
        // document.querySelector("#checkbox_modelisationPMAtmoSud").checked = false;
        // document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked = false;
        // document.querySelector("#checkbox_purpleAir").checked = false;
        // document.querySelector("#checkbox_wind").checked = false;


        // ************************
        //Très important: on start la fonction "loadNebuleAir" une première fois avec document.ready
        //$(document).ready(loadNebuleAir);
        // $(document).ready(loadSensorCommunity);
        //$(document).ready(loadStationRefAtmo);
        // $(document).ready(loadStationMicroAtmo);
        //$(document).ready(loadPurpleAir);
        //$(document).ready(openToast_loading);

        // ************************


}catch(error){return}
})();

var compoundUpper = options.compoundUpper;
var timespanLower = options.timespanLower;
var timeLength = options.timeLength;
var display = options.display;

switch (timespanLower) {
  case 2:
  document.querySelector("#btn_actuel").classList.replace("btn-outline-primary", "btn-primary");
    break;
  case 15:
  document.querySelector("#btn_quartHoraire").classList.replace("btn-outline-primary", "btn-primary");
    break;
  case 60:
  document.querySelector("#btn_horaire").classList.replace("btn-outline-primary", "btn-primary");
    break;
 case 1440:
 document.querySelector("#btn_journalier").classList.replace("btn-outline-primary", "btn-primary");
    break;
}

switch (compoundUpper) {
  case 'PM1':
  document.querySelector("#button_PM1").classList.replace("btn-outline-primary", "btn-primary");
    break;
  case 'PM25':
  document.querySelector("#button_PM25").classList.replace("btn-outline-primary", "btn-primary");
    break;
  case 'PM10':
  document.querySelector("#button_PM10").classList.replace("btn-outline-primary", "btn-primary");
    break;
}

if(display.includes("nebuleair")){
    document.querySelector("#checkbox_micro_stationsParticuliers").checked = true;
    $(document).ready(loadNebuleAir);
}

if(display.includes("sensorcommunity")){
    document.querySelector("#checkbox_sensor_community").checked = true;
    $(document).ready(loadSensorCommunity);
}

if(display.includes("atmosudref")){
    document.querySelector("#checkbox_stationsRefAtmoSud").checked = true;
    $(document).ready(loadStationRefAtmo);
}

if(display.includes("atmosudmicro")){
    document.querySelector("#checkbox_micro_stationsAtmoSud").checked = true;
    $(document).ready(loadStationMicroAtmo);
}

if(display.includes("purpleair")){
    document.querySelector("#checkbox_purpleAir").checked = true;
    $(document).ready(loadPurpleAir);
}


new L.Hash(map);

        if (location.hash) {
            const hash_params = location.hash.split("/");
            coordsCenter = [hash_params[1], hash_params[2]];
            zoomLevel = hash_params[0].substring(1);
        }

        // var polygonPACA = L.geoJSON(paca,{fillOpacity:0.2, color:'black', weight:0, invert:true}).addTo(map);

        var nebuleairParticuliers = new L.layerGroup();
        var sensorCommunity = new L.layerGroup();
        var stationsRefAtmoSud = new L.layerGroup();
        var stationsMicroAtmoSud = new L.layerGroup();
        var modelisationPMAtmoSud = new L.layerGroup();
        var modelisationICAIRAtmoSud = new L.layerGroup();
        var purpleAir = new L.layerGroup();
        var velocityLayer;

        document.querySelector("#button_screenshot").addEventListener("click", screenShot);


        if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
            map.addLayer(nebuleairParticuliers)
        }
        if (document.querySelector("#checkbox_sensor_community").checked) {
            map.addLayer(sensorCommunity)
        }
        if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            map.addLayer(stationsRefAtmoSud)
        }
        if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            map.addLayer(stationsMicroAtmoSud)
        }

        if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
            map.addLayer(modelisationPMAtmoSud)
        }

        if (document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked) {
            map.addLayer(modelisationICAIRAtmoSud)
        }

        if (document.querySelector("#checkbox_purpleAir").checked) {
            map.addLayer(purpleAir)
        }

        document.querySelector("#checkbox_micro_stationsParticuliers").addEventListener("change", switchNebuleAir)
        document.querySelector("#checkbox_sensor_community").addEventListener("change", switchSensorCommunity)
        document.querySelector("#checkbox_stationsRefAtmoSud").addEventListener("change", switchRefAtmo)
        document.querySelector("#checkbox_micro_stationsAtmoSud").addEventListener("change", switchMicroAtmo)
        document.querySelector("#checkbox_modelisationPMAtmoSud").addEventListener("change", switchModelisationPMAtmo)
        document.querySelector("#checkbox_modelisationICAIRAtmoSud").addEventListener("change", switchModelisationICAIRAtmo)
        document.querySelector("#checkbox_purpleAir").addEventListener("change", switchPurpleAir)
        document.querySelector("#checkbox_wind").addEventListener("change", switchWind)

        function switchWind() {
            // console.log(timespanLower);

            if (document.querySelector("#checkbox_wind").checked && timespanLower != 1440) {

                const current_time = new Date();
                let day = String(current_time.getFullYear());
                if((current_time.getMonth()+1)< 10){
                    day += "0";
                    day += (current_time.getMonth()+1);
                }else{
                    day += (current_time.getMonth()+1);
                }
                if(current_time.getDate()< 10){
                    day += "0";
                    day += current_time.getDate();
                }else{
                    day += current_time.getDate();
                }
                let hour ="";
                if(current_time.getHours()< 10){
                    hour += "0";
                    hour += current_time.getHours();
                }else{
                    hour += current_time.getHours();
                }

                let wind_link = "https://meteo.atmosud.org/"+ day +"/wind_field_" + hour +".json";  
                console.log(wind_link);

                $.getJSON(wind_link, function(data) {
                 velocityLayer =  L.velocityLayer({
                                        displayValues: false,
                                        displayOptions: false,
                                        data: data,
                                        velocityScale: 0.002,
                                        colorScale: ["#71C3F2", "#447591"],
                                        minVelocity: 1,
                                        maxVelocity: 5,
                                        overlayName: 'wind_layer',
                                    }).addTo(map);
                });

            } else {
                if (velocityLayer != undefined){
                velocityLayer.remove();
                }
                if(timespanLower == 1440)
                {
                    openToast("La modélisation des vents présente des observations horaires.");
                }
                document.querySelector("#checkbox_wind").checked = false;
            }
        }


        function switchNebuleAir() {
            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {

                if (apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && apiFetchNebuleAir.timespan != timespanLower )) {
                        console.log("Reload NebuleAir!");
                        loadNebuleAir();
                    }else{
                        if (apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > timespanLower * 60 * 1000)) {
                    console.log("Reload NebuleAir!");
                    loadNebuleAir();
                }
            
            }
                map.addLayer(nebuleairParticuliers);

            } else {
                map.removeLayer(nebuleairParticuliers);
            }
            setQueryString();
        }

        function switchSensorCommunity() {

            if (timespanLower != 15 && timespanLower != 60 && timespanLower != 1440) {
                if (document.querySelector("#checkbox_sensor_community").checked) {

                    if (apiFetchSensorCommunity.data.length == 0 || (apiFetchSensorCommunity.data.length != 0 && apiFetchSensorCommunity.timespan != timespanLower )) {
                        console.log("Reload Sensor.Community!");
                        loadSensorCommunity();
                    }else{
                    
                    if (apiFetchSensorCommunity.data.length == 0 || (apiFetchSensorCommunity.data.length != 0 && Date.now() - apiFetchSensorCommunity.timestamp > timespanLower * 60 * 1000)) {
                        console.log("Reload Sensor.Community!");
                        loadSensorCommunity();
                    }
                }
                    map.addLayer(sensorCommunity);
                } else {
                    map.removeLayer(sensorCommunity);
                }
            } else {
                openToast("Pas de moyennes quart-horaire, horaire et journalière pour les capteurs Sensor.Community.");
                document.querySelector("#checkbox_sensor_community").checked = false;
            }
            setQueryString();
        }

        function switchRefAtmo() {

            if (timespanLower != 2) {
                if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) { //ATTENTION CAS 2mins
                    if (apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && apiFetchAtmoSudRef.timespan != timespanLower )) {
                        console.log("Reload AtmoSud Ref!");
                        loadStationRefAtmo();
                    }else{
                    
                    if (apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && apiFetchAtmoSudRef.timespan == timespanLower && Date.now() - apiFetchAtmoSudRef.timestamp > timespanLower * 60 * 1000)) {
                        console.log("Reload AtmoSud Ref!");
                        loadStationRefAtmo();
                    }
                }
                    map.addLayer(stationsRefAtmoSud);
                } else {
                    map.removeLayer(stationsRefAtmoSud);
                }
            } else {
                openToast("Pas de données à intervalle 2 minutes pour les stations de référence AtmoSud");
                document.querySelector("#checkbox_stationsRefAtmoSud").checked = false;
            }
            setQueryString();
        }

        function switchMicroAtmo() {

            if (timespanLower != 2 & timespanLower != 60 & timespanLower != 1440) {
                if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
                    if (apiFetchAtmoSudMicro.data.length == 0 || (apiFetchAtmoSudMicro.data.length != 0 && apiFetchAtmoSudMicro.timespan != timespanLower )) {
                        console.log("Reload AtmoSud Micro!");
                        loadStationMicroAtmo();
                    }else{

                    if (apiFetchAtmoSudMicro.data.length == 0 || (apiFetchAtmoSudMicro.data.length != 0 && Date.now() - apiFetchAtmoSudMicro.timestamp > timespanLower * 60 * 1000)) {
                        console.log("Reload AtmoSud Micro");
                        loadStationMicroAtmo();
                    }
                }
                    map.addLayer(stationsMicroAtmoSud);
                } else {
                    map.removeLayer(stationsMicroAtmoSud);
                }
            } else {
                openToast("Pas de données à intervalles 2 minutes, 1 heure ou 1 jour pour les microstations AtmoSud");
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
            }
            setQueryString();
        }

function switchModelisationPMAtmo() {
    if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked && timespanLower != 1440) {
        loadModelisationPMAtmo();
          map.addLayer(modelisationPMAtmoSud);
                } else {
                    if(modelisationPMAtmoSud != undefined){
            map.removeLayer(modelisationPMAtmoSud);
                    }
                if (timespanLower == 1440)
                   {
                    openToast("La modélisation des particules fines présente des observations horaires.");
                   }
                   document.querySelector("#checkbox_modelisationPMAtmoSud").checked = false;
                }
}

function switchModelisationICAIRAtmo() {
    if (document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked && timespanLower != 1440) {
        loadModelisationICAIRAtmo();
          map.addLayer(modelisationICAIRAtmoSud);
                } else {
                    if(modelisationICAIRAtmoSud != undefined){
            map.removeLayer(modelisationICAIRAtmoSud);
                    }
                   if (timespanLower == 1440)
                   {
                    openToast("La modélisation ICAIRh présente des observations horaires.");
                   }
                   document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked = false;
                }
}

function switchPurpleAir() {
            if (document.querySelector("#checkbox_purpleAir").checked) {

                if (apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && apiFetchPurpleAir.timespan != timespanLower )) {
                        console.log("Reload PurpleAir!");
                        loadPurpleAir();
                    }else{

                if (apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > timespanLower * 60 * 1000)) {
                    console.log("Reload PurpleAir!");
                    loadPurpleAir();
                }
            }
                map.addLayer(purpleAir);

            } else {
                map.removeLayer(purpleAir);
            }
            setQueryString();
        }

        document.querySelector("#button_PM1").addEventListener("click", choosePM1)
        document.querySelector("#button_PM25").addEventListener("click", choosePM25)
        document.querySelector("#button_PM10").addEventListener("click", choosePM10)

        function choosePM1() {
            document.querySelector("#button_PM10").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM25").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM1").classList.replace("btn-outline-primary", "btn-primary");
            compoundUpper = "PM1";
            document.querySelector("#div_button_seuils_PM10").style.visibility = "hidden";
            document.querySelector("#div_button_seuils_PM125").style.visibility = "visible";

            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }

            if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            stationsMicroAtmoSud.clearLayers();
            changeStationMicroAtmo();
            }

            if (document.querySelector("#checkbox_sensor_community").checked) {
                sensorCommunity.clearLayers();
                changeSensorCommunity();
            }

            if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            stationsRefAtmoSud.clearLayers();
            changeStationRefAtmo();
            }

            if (document.querySelector("#checkbox_purpleAir").checked) {
            purpleAir.clearLayers();
            changePurpleAir();
            }

            if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
                modelisationPMAtmoSud.clearLayers();
                loadModelisationPMAtmo();
                document.querySelector("#checkbox_modelisationPMAtmoSud").checked = false;
            }

            setQueryString();
        }

        function choosePM25() {
            document.querySelector("#button_PM10").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM25").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#button_PM1").classList.replace("btn-primary", "btn-outline-primary");
            compoundUpper = "PM25";
            document.querySelector("#div_button_seuils_PM10").style.visibility = "hidden";
            document.querySelector("#div_button_seuils_PM125").style.visibility = "visible";

            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }

            if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            stationsMicroAtmoSud.clearLayers();
            changeStationMicroAtmo();
            }

            if (document.querySelector("#checkbox_sensor_community").checked) {
                sensorCommunity.clearLayers();
                changeSensorCommunity();
            }

            if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            stationsRefAtmoSud.clearLayers();
            changeStationRefAtmo();
            }

            if (document.querySelector("#checkbox_purpleAir").checked) {
            purpleAir.clearLayers();
            changePurpleAir();
            }

            if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
                modelisationPMAtmoSud.clearLayers();
                loadModelisationPMAtmo();
            }
            setQueryString();
        }

        function choosePM10() {
            document.querySelector("#button_PM10").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#button_PM25").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#button_PM1").classList.replace("btn-primary", "btn-outline-primary");
            compoundUpper = "PM10";
            document.querySelector("#div_button_seuils_PM10").style.visibility = "visible";
            document.querySelector("#div_button_seuils_PM125").style.visibility = "hidden";

            if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }

            if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
            stationsMicroAtmoSud.clearLayers();
            changeStationMicroAtmo();
            }

            if (document.querySelector("#checkbox_sensor_community").checked) {
                sensorCommunity.clearLayers();
                changeSensorCommunity();
            }

            if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
            stationsRefAtmoSud.clearLayers();
            changeStationRefAtmo();
            }

            if (document.querySelector("#checkbox_purpleAir").checked) {
            purpleAir.clearLayers();
            changePurpleAir();
            }
            
            if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked) {
                modelisationPMAtmoSud.clearLayers();
                loadModelisationPMAtmo();
            }
            setQueryString();
        }

        document.querySelector("#btn_actuel").addEventListener("click", chooseActuel)
        document.querySelector("#btn_quartHoraire").addEventListener("click", choose15)
        document.querySelector("#btn_horaire").addEventListener("click", choose60)
        document.querySelector("#btn_journalier").addEventListener("click", choose1440)

        function chooseActuel() {
            document.querySelector("#btn_journalier").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-outline-primary", "btn-primary");
            timespanLower = 2;

        const date = new Date();
        const hour = date.getHours();
        const min = date.getMinutes();
        document.querySelector("#button_horloge").innerHTML = hour + ":" + (min < 10 ? '0' : '') + min;  //2min par 


        if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 2 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 2 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }
        
        if(document.querySelector("#checkbox_micro_stationsAtmoSud").checked){
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
                map.removeLayer(stationsMicroAtmoSud);
                openToast("Pas de données à intervalle 2 minutes pour les microstations AtmoSud");
            }

        if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
            document.querySelector("#checkbox_stationsRefAtmoSud").checked = false;
            map.removeLayer(stationsRefAtmoSud);
            openToast("Pas de données à intervalle 2 minutes pour les stations de référence AtmoSud");
        }

        if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 2 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 2 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }
            setQueryString();
        }

        function choose15() {
            document.querySelector("#btn_journalier").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-primary", "btn-outline-primary");
            timespanLower = 15;

            const end = new Date();
            const hour2 = end.getHours();
            const min_ori2 = end.getMinutes();

            if (min_ori2 <= 15)
            {
               var  min2 = 0;
            }else if(min_ori2 > 15 && min_ori2 <=30)
            {
                var  min2 = 15;
            }else if(min_ori2 > 30 && min_ori2 <=45)
            {
                var  min2 = 30;
            }else
            {
                var min2 =45;

            }

            const get_start = end.setMinutes(end.getMinutes() - 15);
            const start = new Date(get_start);
            const hour1 = start.getHours();
            const min_ori1 = start.getMinutes();

            if (min_ori1 <= 15)
            {
               var  min1 = 0;
            }else if(min_ori1 > 15 && min_ori1 <=30)
            {
                var  min1 = 15;
            }else if(min_ori1 > 30 && min_ori1 <=45)
            {
                var  min1 = 30;
            }else
            {
                var min1 =45;

            }
        
            document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ;  


            if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 15 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 15 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }

            if(document.querySelector("#checkbox_sensor_community").checked){
            document.querySelector("#checkbox_sensor_community").checked = false;
            map.removeLayer(sensorCommunity);
            openToast("Pas de données à intervalle 15 minutes pour les capteurs Sensor.Community");
        }

            if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
            if (apiFetchAtmoSudRef.timespan != 15 || apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > 15 * 60 * 1000))
            {
                stationsRefAtmoSud.clearLayers();
                loadStationRefAtmo();
            }else{
                stationsRefAtmoSud.clearLayers();
                changeStationRefAtmo();
            }
            }

            if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 15 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 15 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }

            setQueryString();
        }

        function choose60() {
            document.querySelector("#btn_journalier").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-primary", "btn-outline-primary");
            timespanLower = 60;

            const end = new Date();
            const hour2 = end.getHours();
            const min2 = end.getMinutes();
            const get_start = end.setHours(end.getHours() - 1);
            const start = new Date(get_start);
            const hour1 = start.getHours();
            const min1 = start.getMinutes();
            // document.querySelector("#button_horloge").innerHTML = hour1 + ":" + (min1 < 10 ? '0' : '') + min1 + " à " + hour2 + ":" + (min2 < 10 ? '0' : '') + min2 ; 
            document.querySelector("#button_horloge").innerHTML = hour1 + ":" + "00" + " à " + hour2 + ":" + "00"; 


            if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 60 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 60 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }
        
            if(document.querySelector("#checkbox_sensor_community").checked){
            document.querySelector("#checkbox_sensor_community").checked = false;
            map.removeLayer(sensorCommunity);
            openToast("Pas de données à intervalle 1 heure pour les capteurs Sensor.Community");
        }

            if(document.querySelector("#checkbox_micro_stationsAtmoSud").checked){
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
                map.removeLayer(stationsMicroAtmoSud);
                openToast("Pas de données à intervalles 1 heure pour les microstations AtmoSud");
            }

            if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
            if (apiFetchAtmoSudRef.timespan != 60 || apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > 60 * 60 * 1000))
            {
                stationsRefAtmoSud.clearLayers();
                loadStationRefAtmo();
            }else{
                stationsRefAtmoSud.clearLayers();
                changeStationRefAtmo();
            }
            }

            if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 60 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 60 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }
            setQueryString();
        }

        function choose1440() {
            document.querySelector("#btn_journalier").classList.replace("btn-outline-primary", "btn-primary");
            document.querySelector("#btn_horaire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_quartHoraire").classList.replace("btn-primary", "btn-outline-primary");
            document.querySelector("#btn_actuel").classList.replace("btn-primary", "btn-outline-primary");
            timespanLower = 1440;

            const date = new Date();
            const get_datemoins1 = date.setHours(date.getHours() - 24);
            const datemoins1 = new Date(get_datemoins1);
            const jour = datemoins1.getDate();
            const mois = datemoins1.getMonth() + 1;
            document.querySelector("#button_horloge").innerHTML = (jour < 10 ? '0' : '') + jour + "/" + (mois < 10 ? '0' : '') + mois;  //2min par défaut


            if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){
            if (apiFetchNebuleAir.timespan != 1440 || apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > 1440 * 60 * 1000))
            {
                nebuleairParticuliers.clearLayers();
                loadNebuleAir();
            }else{
                nebuleairParticuliers.clearLayers();
                changeNebuleAir();
            }
            }

            if(document.querySelector("#checkbox_sensor_community").checked){
            document.querySelector("#checkbox_sensor_community").checked = false;
            map.removeLayer(sensorCommunity);
            openToast("Pas de données à intervalle 1 jour pour les capteurs Sensor.Community");
        }

            if(document.querySelector("#checkbox_micro_stationsAtmoSud").checked){
                document.querySelector("#checkbox_micro_stationsAtmoSud").checked = false;
                map.removeLayer(stationsMicroAtmoSud);
                openToast("Pas de données à intervalles 1 jour pour les microstations AtmoSud");
            }

            if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){
                if (apiFetchAtmoSudRef.timespan != 1440 || apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > 1440 * 60 * 1000))
            {
                stationsRefAtmoSud.clearLayers();
                loadStationRefAtmo();
            }else{
                stationsRefAtmoSud.clearLayers();
                changeStationRefAtmo();
            }

            }

            if(document.querySelector("#checkbox_purpleAir").checked){
            if (apiFetchPurpleAir.timespan != 1440 || apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > 15 * 60 * 1000))
            {
                purpleAir.clearLayers();
                loadPurpleAir();
            }else{
                purpleAir.clearLayers();
                changePurpleAir();
            }
            }

            if(document.querySelector("#checkbox_wind").checked){
                document.querySelector("#checkbox_wind").checked = false;
            map.removeLayer(velocityLayer);
            openToast("La modélisation des vents présente des observations horaires.");
            }

            if(document.querySelector("#checkbox_modelisationPMAtmoSud").checked){
                document.querySelector("#checkbox_modelisationPMAtmoSud").checked = false;
            map.removeLayer(modelisationPMAtmoSud);
            openToast("La modélisation des particules fines présente des observations horaires.");
            }

            if(document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked){
                document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked = false;
            map.removeLayer(modelisationICAIRAtmoSud);
            openToast("La modélisation ICAIRh présente des observations horaires.");
            }
            setQueryString();
        }

        // //ouverture du toast
        // function openToast_loading() {
        //     const toastLiveExample = document.getElementById('loadToast')
        //     const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
        //     console.log("Showing loading toast");
        //     toastBootstrap.show()
        // }
        // //fermeture du toast
        // function closeToast_loading() {
        //     const toastLiveExample = document.getElementById('loadToast')
        //     const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastLiveExample)
        //     console.log("Hiding loading toast");
        //     toastBootstrap.hide()
        // }

                //ouverture du toast
        function openToast(message) {
            let toastDiv= document.getElementById('messageToast');
            document.getElementById('message').innerText = message;
            let toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastDiv);
            console.log("Showing message toast");
            toastBootstrap.show()
        }
        //fermeture du toast
        function closeToast() {
            let toastDiv = document.getElementById('messageToast');
            let toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastDiv);
            console.log("Hiding messgae toast");
            toastBootstrap.hide()
        }

        //fonction qui ouvre le side panel
        function OpenSidePanel(sensor) {
            const targetDiv = document.getElementById("sidePanel");
            console.log(sensor);
            targetDiv.style.display = "block";
            document.getElementById("title_deviceName").innerHTML = sensor;

            switch(timespanLower) {
            case 2:
                var tempo = " à 2 minutes ";
                break;
            case 15:
                var tempo = " quart-horaires ";
                break;
            case 60:
                var tempo = " horaires ";
                break;
            case 1440:
                var tempo = " journalières ";
                break;
            } 

            document.getElementById("card-title").innerText = 'Evolution des concentrations' + tempo + 'en particules fines (µg/m3)';

           var timespanGraph = timespanLower;
           var timeLengthGraph;

           switch (timespanLower) {
  case 2:
  timeLengthGraph = 3;
    break;
  case 15:
  timeLengthGraph = 24;
    break;
  case 60:
  timeLengthGraph = 48;
    break;
  case 1440:
  timeLengthGraph = 168;
    break;
}

            if (sensor.includes("nebuleair")) {
                let id = sensor.split("-")[1];
                load1NebuleAir(id,timeLengthGraph,timespanGraph);
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',1,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',3,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',24,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',48,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',168,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',720,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',8760,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',2,false)" class="btn btn-outline-secondary btn-sm">2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',15,false)" class="btn btn-outline-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',60,false)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLengthGraph + ',1440,false)" class="btn btn-outline-secondary btn-sm">24h</button>';          
               
                buttonsSwitcher(timeLengthGraph,timespanGraph,false);

               if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }

            if (sensor.includes("sensor.community")) {
                let id = sensor.split("-")[1];
                document.getElementById("chartSensor").style.display = 'block';
                document.getElementById("chartSensor2").style.display = 'none';
                document.getElementById("chartSensor").src = "https://api-rrd.madavi.de:3000/grafana/d-solo/000000004/single-sensor-view-for-map?orgId=1&var-node=" + id + "&panelId=2";
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\',1)" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 3)" class="btn btn-outline-secondary btn-sm" disabled>3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 24)" class="btn btn-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 48)" class="btn btn-outline-secondary btn-sm" disabled>48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 168)" class="btn btn-outline-secondary btn-sm" disabled>1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + sensor + '\', 720)" class="btn btn-outline-secondary btn-sm" disabled>1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm" disabled>1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-secondary btn-sm">2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>24h</button>';
            }

            if (sensor.includes("microstationAtmoSud")) {
                var id = sensor.split("-")[1];
                load1MicroAtmo(id,timeLength); 
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\',1)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 3)" class="btn btn-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 24)" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 48)" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 168)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\', 720)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoMicro(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm" disabled>1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" class="btn btn-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>24h</button>';
            }

            if (sensor.includes("stationRefAtmoSud")) {
                var id = sensor.split("-")[1];
                load1RefAtmo(id,timeLengthGraph,timespanGraph); 
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 1,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 3,' + timespanGraph + ',false)" class="btn btn-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 24,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 48,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 168,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 720),' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',8760,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLengthGraph + ',15,false)" class="btn btn-outline-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLengthGraph + ',60,false)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLengthGraph + ',1440,false)" class="btn btn-outline-secondary btn-sm">24h</button>';                
                buttonsSwitcher(timeLengthGraph,timespanGraph,false);
                
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }

            if (sensor.includes("purpleair")) {
                let id = sensor.split("-")[1];
                load1PurpleAir(id,timeLengthGraph,timespanGraph);
                document.getElementById("chartSensor").style.display = 'none';
                document.getElementById("chartSensor2").style.display = 'block';
                document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',1,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',3,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">3h</button>';
                document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',24,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
                document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',48,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
                document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',168,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
                document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',720,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 mois</button>';
                document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
                document.getElementById("button2m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',2)" class="btn btn-outline-secondary btn-sm">2m</button>';
                document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
                document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
                document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLengthGraph + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
                buttonsSwitcher(timeLengthGraph,timespanGraph,false);

               if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }
        }

        function chooseTimeSensorCommunity(sensor, hours) {
            document.getElementById("chartSensor").src = "https://api-rrd.madavi.de:3000/grafana/d-solo/000000004/single-sensor-view-for-map?orgId=1&var-node=" + sensor + "&panelId=2";
            if (hours == 24) {
                document.getElementById("button24h").classList.replace("btn-outline-secondary", "btn-secondary");
            }

            //A COMPLETER
        }

        function chooseTimeNebuleAir(sensor, hours, timespan, modal) {
            timeLengthGraph = hours;
            timespanGraph = timespan;
            console.log(sensor);
            console.log(hours);
            console.log(timespan);

            if(!modal){

            switch(timespan) {
            case 2:
                var tempo = " à 2 minutes ";
                break;
            case 15:
                var tempo = " quart-horaires ";
                break;
            case 60:
                var tempo = " horaires ";
                break;
            case 1440:
                var tempo = " journalières ";
                break;
            } 

            document.getElementById("card-title").innerText = 'Evolution des concentrations' + tempo + 'en particules fines (µg/m3)';      
            load1NebuleAir(sensor,timeLengthGraph,timespanGraph);
            document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',1,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',3,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">3h</button>';
            document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',24,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">24h</button>';
            document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',48,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">48h</button>';
            document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',168,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
            document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',720,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
            document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',8760,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 an</button>';
            document.getElementById("button2m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',2,false)" class="btn btn-outline-secondary btn-sm">2m</button>';
            document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',15,false)" class="btn btn-outline-secondary btn-sm">15m</button>';
            document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',60,false)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',1440,false)" class="btn btn-outline-secondary btn-sm">24h</button>';
            buttonsSwitcher(timeLengthGraph,timespanGraph,modal);
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
        }else{
            load1NebuleAirModal(sensor,timeLengthGraph,timespanGraph);
            document.getElementById("modal_button1h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',1,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("modal_button3h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',3,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">3h</button>';
            document.getElementById("modal_button24h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',24,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">24h</button>';
            document.getElementById("modal_button48h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',48,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">48h</button>';
            document.getElementById("modal_button1s").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',168,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
            document.getElementById("modal_button1m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',720,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
            document.getElementById("modal_button1a").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',8760,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1 an</button>';
            document.getElementById("modal_button2m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',2,true)" class="btn btn-outline-secondary btn-sm">2m</button>';
            document.getElementById("modal_button15m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',15,true)" class="btn btn-outline-secondary btn-sm">15m</button>';
            document.getElementById("modal_button60m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',60,true)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("modal_button1440m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + sensor + '\',' + timeLengthGraph + ',1440,true)" class="btn btn-outline-secondary btn-sm">24h</button>';
            buttonsSwitcher(timeLengthGraph,timespanGraph,modal);
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("modal_button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("modal_button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("modal_button2m").children[0].setAttribute("disabled","");
              document.getElementById("modal_button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("modal_button2m").children[0].removeAttribute("disabled");
              document.getElementById("modal_button15m").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("modal_button2m").children[0].setAttribute("disabled","");
              document.getElementById("modal_button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("modal_button2m").children[0].removeAttribute("disabled");
              document.getElementById("modal_button15m").children[0].removeAttribute("disabled");
            }
        }
        }


                //changer la couleur du bouton en fonction du choix (not working?)
        function chooseTimeAtmoMicro(sensor, hours) {
            console.log(sensor);
            console.log(hours);
            load1MicroAtmo(sensor,hours)
            buttonsSwitcher(hours,15,false);  //REVOIR
        }


        function chooseTimeAtmoRef(sensor, hours, timespan, modal) {
            timeLengthGraph = hours;
            timespanGraph = timespan;
            console.log(sensor);
            console.log(hours);
            console.log(timespan);


            if(!modal){

            load1RefAtmo(sensor,timeLengthGraph,timespanGraph);
            document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',1,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 3,' + timespanGraph + ',false)" class="btn btn-secondary btn-sm">3h</button>';
            document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 24,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">24h</button>';
            document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 48,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">48h</button>';
            document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 168,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
            document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 720,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
            document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',8760,' + timespanGraph + ',false)" class="btn btn-outline-secondary btn-sm">1 an</button>';
            document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
            document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',15,false)" class="btn btn-outline-secondary btn-sm">15m</button>';
            document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',60,false)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',1440,false)" class="btn btn-outline-secondary btn-sm">24h</button>';
            
            buttonsSwitcher(timeLengthGraph,timespanGraph,false);
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("button2m").children[0].setAttribute("disabled","");
              document.getElementById("button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("button2m").children[0].removeAttribute("disabled");
              document.getElementById("button15m").children[0].removeAttribute("disabled");
            }
            }else{
            load1RefAtmoModal(sensor,timeLengthGraph,timespanGraph);
            document.getElementById("modal_button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',1,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("modal_button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 3,' + timespanGraph + ',true)" class="btn btn-secondary btn-sm">3h</button>';
            document.getElementById("modal_button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 24,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">24h</button>';
            document.getElementById("modal_button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 48,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">48h</button>';
            document.getElementById("modal_button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 168,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
            document.getElementById("modal_button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 720,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
            document.getElementById("modal_button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',8760,' + timespanGraph + ',true)" class="btn btn-outline-secondary btn-sm">1 an</button>';
            document.getElementById("modal_button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
            document.getElementById("modal_button15m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',15,true)" class="btn btn-outline-secondary btn-sm">15m</button>';
            document.getElementById("modal_button60m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',60,true)" class="btn btn-outline-secondary btn-sm">1h</button>';
            document.getElementById("modal_button1440m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',1440,true)" class="btn btn-outline-secondary btn-sm">24h</button>';
            
            buttonsSwitcher(timeLengthGraph,timespanGraph,true);
            if(timespanGraph == 2 || timespanGraph == 15){
              document.getElementById("modal_button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("modal_button1a").children[0].removeAttribute("disabled");
            }

            if(timeLengthGraph == 8760){
              document.getElementById("modal_button2m").children[0].setAttribute("disabled","");
              document.getElementById("modal_button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("modal_button2m").children[0].removeAttribute("disabled");
              document.getElementById("modal_button15m").children[0].removeAttribute("disabled");
            }
            }

            }


        // function chooseTimeAtmoRef(sensor, hours, timespan) {
        //     timeLengthGraph = hours;
        //     timespanGraph = timespan;
        //     console.log(sensor);
        //     console.log(hours);
        //     console.log(timespan);       
        //     load1RefAtmo(sensor,timeLengthGraph,timespanGraph);
        //     document.getElementById("button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',1,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
        //     document.getElementById("button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 3,' + timespanGraph + ')" class="btn btn-secondary btn-sm">3h</button>';
        //     document.getElementById("button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 24,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
        //     document.getElementById("button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 48,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
        //     document.getElementById("button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 168,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
        //     document.getElementById("button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\', 720,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 mois</button>';
        //     document.getElementById("button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',8760,' + timespanGraph + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
        //     document.getElementById("button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
        //     document.getElementById("button15m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
        //     document.getElementById("button60m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
        //     document.getElementById("button1440m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + sensor + '\',' + timeLengthGraph + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
            
     
        //     buttonsSwitcher(timeLengthGraph,timespanGraph,false);
        //     if(timespanGraph == 2 || timespanGraph == 15){
        //       document.getElementById("button1a").children[0].setAttribute("disabled","");
        //     }else{
        //       document.getElementById("button1a").children[0].removeAttribute("disabled");
        //     }

        //     if(timeLengthGraph == 8760){
        //       document.getElementById("button2m").children[0].setAttribute("disabled","");
        //       document.getElementById("button15m").children[0].setAttribute("disabled","");
        //     }else{
        //       document.getElementById("button2m").children[0].removeAttribute("disabled");
        //       document.getElementById("button15m").children[0].removeAttribute("disabled");
        //     }
        //     }


        //fonction qui ferme le side panel
        function CloseSidePanel() {
            const targetDiv = document.getElementById("sidePanel");
            targetDiv.style.display = "none";
        }


function buttonsSwitcher(hours,timespan,modal){
    console.log(hours);
    console.log(timespan);

    if (!modal){

    switch (hours) {
            case 1:
                document.getElementById("button1h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 3:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 24:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 48:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 168:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 720:
                document.getElementById("button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                break;
            }

            switch (timespan) {
            case 2:
                document.getElementById("button2m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 15:
                document.getElementById("button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 60:
                document.getElementById("button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 1440:
                document.getElementById("button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("button1440m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                break;
            }
        }else{

            switch (hours) {
            case 1:
                document.getElementById("modal_button1h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 3:
                document.getElementById("modal_button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button3h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 24:
                document.getElementById("modal_button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button24h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 48:
                document.getElementById("modal_button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button48h").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 168:
                document.getElementById("modal_button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1s").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button1m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 720:
                document.getElementById("modal_button1h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button3h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button24h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button48h").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1s").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                break;
            }

            switch (timespan) {
            case 2:
                document.getElementById("modal_button2m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 15:
                document.getElementById("modal_button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button15m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 60:
                document.getElementById("modal_button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button60m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                document.getElementById("modal_button1440m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                break;
            case 1440:
                document.getElementById("modal_button2m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button15m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button60m").children[0].classList.replace("btn-secondary", "btn-outline-secondary");
                document.getElementById("modal_button1440m").children[0].classList.replace("btn-outline-secondary", "btn-secondary");
                break;
            }

        }
}

function setQueryString() {
	let stateObj = {};
	let new_path = window.location.pathname + "?";

switch (timespanLower) {
  case 2:
  new_path += "minutes=2&"
    break;
  case 15:
  new_path += "minutes=15&"
    break;
  case 60:
  new_path += "minutes=60&"
    break;
 case 1440:
 new_path += "minutes=1440&"
    break;
}

switch (compoundUpper) {
  case 'PM1':
  new_path += "concentration=PM1"
    break;
  case 'PM25':
  new_path += "concentration=PM25"
    break;
  case 'PM10':
  new_path += "concentration=PM10"
    break;
}

let displayString = "";

if(document.querySelector("#checkbox_micro_stationsParticuliers").checked){displayString += "nebuleair,"}
if(document.querySelector("#checkbox_sensor_community").checked){displayString += "sensorcommunity,"}
if(document.querySelector("#checkbox_purpleAir").checked){displayString += "purpleair,"}
if(document.querySelector("#checkbox_micro_stationsAtmoSud").checked){displayString += "atmosudmicro,"}
if(document.querySelector("#checkbox_stationsRefAtmoSud").checked){displayString += "atmosudref,"}
// if(document.querySelector("#checkbox_modelisationPMAtmoSud").checked){displayString += "sensorcommunity,"}
// if(document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked){displayString += "sensorcommunity,"}
// if(document.querySelector("#checkbox_wind").checked){displayString += "sensorcommunity,"}


new_path += "&affichage=" + displayString;

	new_path = new_path + location.hash;
	console.log(new_path);
	history.pushState(stateObj,document.title,new_path);
}

function screenShot() {
            console.log("Screenshot!");


    html2canvas(document.body,{
        logging: false,
        useCORS:true  //REVOIR LES OPTIONS
    }).then(function(canvas) {
        canvas.toBlob(function(blob) {
            window.saveAs(blob, "screenshot.png");
        });
    });


    // html2canvas(document.body,{
    //     onrendered: function(canvas){

    //         canvas.toBlob(function(blob) {
    //         window.saveAs(blob, "screenshot.png");
    //     });

    //     }
    // });

    // html2canvas(document.body).then(function(canvas) {
  	// var link =  document.createElement("a");
    // link.setAttribute('download', 'MintyPaper.png');
    // link.setAttribute('href', canvas.toDataURL("image/png").replace("image/png", "image/octet-stream"));
    // link.click();
	// });

}

// Date.prototype.stdTimezoneOffset = function () {
//     var jan = new Date(this.getFullYear(), 0, 1);
//     var jul = new Date(this.getFullYear(), 6, 1);
//     return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
// }

// Date.prototype.isDstObserved = function () {
//     return this.getTimezoneOffset() < this.stdTimezoneOffset();
// }

function timeDateCounter(timestamp){

var timestamp_UTC;
// const UTCoffset = -new Date().getTimezoneOffset() / 60;
// const DST = new Date().isDstObserved();
// console.log(UTCoffset);
// console.log(DST);

//console.log(timestamp.replace(' ','T') + '.000Z');
var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && window['safari'].pushNotification));
// console.log(isSafari);

if(isSafari){
    if(timestamp != null){
        if(typeof timestamp == 'string'){
            if (!timestamp.includes('T')){
        timestamp_UTC = new Date(timestamp.replace(" ","T")+"+00:00");
            }else{
                timestamp_UTC = new Date(timestamp);
            }
        }else{
            timestamp_UTC = new Date(timestamp);
        }
    }else{
        return " pas de donnée disponible"
    }
}else{
if(timestamp != null){
    if(typeof timestamp == 'string'){
    if (!timestamp.includes('T')){
        timestamp_UTC = new Date(timestamp.replace(" ","T")+"+00:00");
    }else{
        timestamp_UTC = new Date(timestamp);
        }
    }else{
        timestamp_UTC = new Date(timestamp);
    }
    }else{
        return " pas de donnée disponible"
    }
}


// console.log(timestamp_UTC);
const now = new Date(Date.now());

// let difference = now.getTime() - timestamp_UTC.getTime();


let difference = Math.floor((now - timestamp_UTC)/86400000);
// console.log(difference);
// console.log(now - timestamp_UTC);

var date_texte ="";
let horaire_texte="";

switch(difference) {
  case 0:
    if(now.getDay() == timestamp_UTC.getDay()){
    date_texte = " aujourd'hui";
    }else{
        date_texte = " hier";
    }
    break;
  case 1:
    date_texte = " hier";
    break;
  case 2:
    date_texte = " avant-hier";
    break;
  default:
    date_texte += "il y a " + String(difference) + " jours";
//     if(timestamp_UTC.getDate()< 10){
//     date_texte += "0";
//     date_texte += timestamp_UTC.getDate();
//   }else{
//     date_texte += timestamp_UTC.getDate();
//   }
//   date_texte += "/";
//   if((timestamp_UTC.getMonth()+1)< 10){
//     date_texte += "0";
//     date_texte += (timestamp_UTC.getMonth()+1);
//   }else{
//     date_texte += (timestamp_UTC.getMonth()+1);
//   }
//   date_texte += "/";
//   date_texte += timestamp_UTC.getFullYear();
} 

//horaire
if(timestamp_UTC.getHours()< 10){
horaire_texte += "0";
horaire_texte += timestamp_UTC.getHours();
}else{
horaire_texte += timestamp_UTC.getHours();
}
horaire_texte += "h";
if(timestamp_UTC.getMinutes()< 10){
horaire_texte += "0";
horaire_texte += timestamp_UTC.getMinutes();
}else{
horaire_texte += timestamp_UTC.getMinutes();
} 

return date_texte + " à " + horaire_texte;
}

function timeDateCounter2(timestamp,timestamp2){

var timestamp_UTC;
// const UTCoffset = -new Date().getTimezoneOffset() / 60;
// const DST = new Date().isDstObserved();
// console.log(UTCoffset);
// console.log(DST);

//console.log(timestamp.replace(' ','T') + '.000Z');
var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && window['safari'].pushNotification));
// console.log(isSafari);

if(isSafari){
    if(timestamp != null){
        if(typeof timestamp == 'string'){
            if (!timestamp.includes('T')){
        timestamp_UTC = new Date(timestamp.replace(" ","T")+"+00:00");
            }else{
                timestamp_UTC = new Date(timestamp);
            }
        }else{
            timestamp_UTC = new Date(timestamp);
        }
    }else{
        if(timestamp2 != null){
        if(typeof timestamp2 == 'string'){
            if (!timestamp2.includes('T')){
        timestamp_UTC = new Date(timestamp2.replace(" ","T")+"+00:00");
            }else{
                timestamp_UTC = new Date(timestamp2);
            }
        }else{
            timestamp_UTC = new Date(timestamp2);
        }
    }else{
        return " pas de donnée disponible";
        }
    }
}else{
if(timestamp != null){
    if(typeof timestamp == 'string'){
    if (!timestamp.includes('T')){
        timestamp_UTC = new Date(timestamp.replace(" ","T")+"+00:00");
    }else{
        timestamp_UTC = new Date(timestamp);
        }
    }else{
        timestamp_UTC = new Date(timestamp);
    }
    }else{

        if(timestamp2 != null){
    if(typeof timestamp2 == 'string'){
    if (!timestamp2.includes('T')){
        timestamp_UTC = new Date(timestamp2.replace(" ","T")+"+00:00");
    }else{
        timestamp_UTC = new Date(timestamp2);
        }
    }else{
        timestamp_UTC = new Date(timestamp2);
    }
    }else{
        return " pas de donnée disponible";
        }  
    }
}


// console.log(timestamp_UTC);
const now = new Date(Date.now());

// let difference = now.getTime() - timestamp_UTC.getTime();


let difference = Math.floor((now - timestamp_UTC)/86400000);
// console.log(difference);
// console.log(now - timestamp_UTC);

var date_texte ="";
let horaire_texte="";

switch(difference) {
  case 0:
    if(now.getDay() == timestamp_UTC.getDay()){
    date_texte = " aujourd'hui";
    }else{
        date_texte = " hier";
    }
    break;
  case 1:
    date_texte = " hier";
    break;
  case 2:
    date_texte = " avant-hier";
    break;
  default:
    date_texte += "il y a " + String(difference) + " jours";
//     if(timestamp_UTC.getDate()< 10){
//     date_texte += "0";
//     date_texte += timestamp_UTC.getDate();
//   }else{
//     date_texte += timestamp_UTC.getDate();
//   }
//   date_texte += "/";
//   if((timestamp_UTC.getMonth()+1)< 10){
//     date_texte += "0";
//     date_texte += (timestamp_UTC.getMonth()+1);
//   }else{
//     date_texte += (timestamp_UTC.getMonth()+1);
//   }
//   date_texte += "/";
//   date_texte += timestamp_UTC.getFullYear();
} 

//horaire
if(timestamp_UTC.getHours()< 10){
horaire_texte += "0";
horaire_texte += timestamp_UTC.getHours();
}else{
horaire_texte += timestamp_UTC.getHours();
}
horaire_texte += "h";
if(timestamp_UTC.getMinutes()< 10){
horaire_texte += "0";
horaire_texte += timestamp_UTC.getMinutes();
}else{
horaire_texte += timestamp_UTC.getMinutes();
} 

return date_texte + " à " + horaire_texte;
}


function modalCreator(type,data1,data2,data3,data4){

    if(type == "nebuleair"){

        document.getElementById("modal_logo").src="img/LogoNebuleAir.png";

        let id = data1.split("-")[1];
              document.getElementById("modal_sensorid").innerHTML = "nebuleair-" + id;

              switch (timespanLower) {
  case 2:
  timeLength = 3;
    break;
  case 15:
  timeLength = 24;
    break;
  case 60:
  timeLength = 48;
    break;
  case 1440:
  timeLength = 168;
    break;
}

              load1NebuleAirModal(id,timeLength,timespanLower);
              document.getElementById("modal_chartSensor").style.display = 'none';
              document.getElementById("modal_chartSensor2").style.display = 'block';
              document.getElementById("modal_button1h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',1,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1h</button>';
              document.getElementById("modal_button3h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',3,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">3h</button>';
              document.getElementById("modal_button24h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',24,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">24h</button>';
              document.getElementById("modal_button48h").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',48,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">48h</button>';
              document.getElementById("modal_button1s").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',168,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
              document.getElementById("modal_button1m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',720,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
              document.getElementById("modal_button1a").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',8760,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1 an</button>';
              document.getElementById("modal_button2m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLength + ',2,true)" class="btn btn-outline-secondary btn-sm">2m</button>';
              document.getElementById("modal_button15m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLength + ',15,true)" class="btn btn-outline-secondary btn-sm">15m</button>';
              document.getElementById("modal_button60m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLength + ',60,true)" class="btn btn-outline-secondary btn-sm">1h</button>';
              document.getElementById("modal_button1440m").innerHTML = '<button type="button" onclick="chooseTimeNebuleAir(\'' + id + '\',' + timeLength + ',1440,true)" class="btn btn-outline-secondary btn-sm">24h</button>';
             buttonsSwitcher(timeLength,timespanLower,true);

             if(timespanLower == 2 || timespanLower == 15){
            document.getElementById("modal_button1a").children[0].setAttribute("disabled","");
          }else{
            document.getElementById("modal_button1a").children[0].removeAttribute("disabled");
          }

          if(timeLength == 8760){
            document.getElementById("modal_button2m").children[0].setAttribute("disabled","");
            document.getElementById("modal_button15m").children[0].setAttribute("disabled","");
          }else{
            document.getElementById("modal_button2m").children[0].removeAttribute("disabled");
            document.getElementById("modal_button15m").children[0].removeAttribute("disabled");
          }

          document.getElementById("modal_lastseen").innerText = "Dernière mesure effectuée : " + data2;

          if(data3 != -1){
          document.getElementById("modal_wifilevel").innerText = "Qualité connexion WIFI : " + data3 + "%";
          }else if(data3 == -1 && type != "sensorcommunity"){
            //document.getElementById("modal_wifilevel").innerText = "Capteur déconnecté";
            document.getElementById("modal_wifilevel").innerText = "";
          }else{
            document.getElementById("modal_wifilevel").innerText = "Capteur connecté";
          }
    }

    if(type == "sensorcommunity"){

        document.getElementById("modal_logo").src="img/LogoSensorCommunity.png";
        let id = data1;
              document.getElementById("modal_sensorid").innerHTML = "Sensor.Community-" + id;
              document.getElementById("modal_chartSensor").style.display = 'block';
                document.getElementById("modal_chartSensor2").style.display = 'none';
                document.getElementById("modal_chartSensor").src = "https://api-rrd.madavi.de:3000/grafana/d-solo/000000004/single-sensor-view-for-map?orgId=1&var-node=" + id + "&panelId=2";
                document.getElementById("modal_button1h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\',1)" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("modal_button3h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\', 3)" class="btn btn-outline-secondary btn-sm" disabled>3h</button>';
                document.getElementById("modal_button24h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\', 24)" class="btn btn-secondary btn-sm">24h</button>';
                document.getElementById("modal_button48h").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\', 48)" class="btn btn-outline-secondary btn-sm" disabled>48h</button>';
                document.getElementById("modal_button1s").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\', 168)" class="btn btn-outline-secondary btn-sm" disabled>1 semaine</button>';
                document.getElementById("modal_button1m").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\', 720)" class="btn btn-outline-secondary btn-sm" disabled>1 mois</button>';
                document.getElementById("modal_button1a").innerHTML = '<button type="button" onclick="chooseTimeSensorCommunity(\'' + id + '\',8760,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>1 an</button>';
                document.getElementById("modal_button2m").innerHTML = '<button type="button" class="btn btn-secondary btn-sm">2m</button>';
                document.getElementById("modal_button15m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>15m</button>';
                document.getElementById("modal_button60m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
                document.getElementById("modal_button1440m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>24h</button>';
                document.getElementById("modal_lastseen").innerText = "Dernière mesure effectuée : " + data2;
                if(data3 != -1){
          document.getElementById("modal_wifilevel").innerText = "Qualité connexion WIFI : " + data3 + "%";
          }else if(data3 == -1 && type != "sensorcommunity"){
            //document.getElementById("modal_wifilevel").innerText = "Capteur déconnecté";
            document.getElementById("modal_wifilevel").innerText = "";
          }else{
            document.getElementById("modal_wifilevel").innerText = "Capteur connecté";
          }

    }

    if(type == "atmosudmicro"){

    }

    if(type == "atmosudref"){
        document.getElementById("modal_logo").src="img/LogoAtmoSud.png";
        let id = data1;
        let nom = data4;
        document.getElementById("modal_sensorid").innerHTML = "Station AtmoSud-" + nom;
        document.getElementById("modal_sensorid").onclick = function() {window.open("https://www.atmosud.org/dataviz/mesures-aux-stations?station_id="+ data1, "_blank");};

        switch (timespanLower) {
  case 2:
  timeLength = 3;
    break;
  case 15:
  timeLength = 24;
    break;
  case 60:
  timeLength = 48;
    break;
  case 1440:
  timeLength = 168;
    break;
}

        load1RefAtmoModal(id,timeLength,timespanLower); 
        document.getElementById("modal_chartSensor").style.display = 'none';
        document.getElementById("modal_chartSensor2").style.display = 'block';
        document.getElementById("modal_button1h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 1,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1h</button>';
        document.getElementById("modal_button3h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 3,' + timespanLower + ',true)" class="btn btn-secondary btn-sm">3h</button>';
        document.getElementById("modal_button24h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 24,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">24h</button>';
        document.getElementById("modal_button48h").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 48,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">48h</button>';
        document.getElementById("modal_button1s").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 168,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
        document.getElementById("modal_button1m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\', 720),' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1 mois</button>';
        document.getElementById("modal_button1a").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',8760,' + timespanLower + ',true)" class="btn btn-outline-secondary btn-sm">1 an</button>';
        document.getElementById("modal_button2m").innerHTML = '<button type="button" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
        document.getElementById("modal_button15m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLength + ',15,true)" class="btn btn-outline-secondary btn-sm">15m</button>';
        document.getElementById("modal_button60m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLength + ',60,true)" class="btn btn-outline-secondary btn-sm">1h</button>';
        document.getElementById("modal_button1440m").innerHTML = '<button type="button" onclick="chooseTimeAtmoRef(\'' + id + '\',' + timeLength + ',1440,true)" class="btn btn-outline-secondary btn-sm">24h</button>';                
        buttonsSwitcher(timeLength,timespanLower,true);
                
            if(timespanLower == 2 || timespanLower == 15){
              document.getElementById("modal_button1a").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("modal_button1a").children[0].removeAttribute("disabled");
            }

            if(timeLength == 8760){
              document.getElementById("modal_button2m").children[0].setAttribute("disabled","");
              document.getElementById("modal_button15m").children[0].setAttribute("disabled","");
            }else{
              document.getElementById("modal_button2m").children[0].removeAttribute("disabled");
              document.getElementById("modal_button15m").children[0].removeAttribute("disabled");
            }


            document.getElementById("modal_lastseen").innerText = "Dernière mesure effectuée : " + data2;

if(data3 != -1){
document.getElementById("modal_wifilevel").innerText = "Qualité connexion WIFI : " + data3 + "%";
}else if(data3 == -1 && type != "sensorcommunity"){
  //document.getElementById("modal_wifilevel").innerText = "Capteur déconnecté";
  document.getElementById("modal_wifilevel").innerText = "";
}else{
  document.getElementById("modal_wifilevel").innerText = "Capteur connecté";
}
    }


    if(type == "purpleair"){
        document.getElementById("modal_logo").src="img/LogoPurpleAir.png";
        let id = data1;
        document.getElementById("modal_sensorid").innerHTML = "PurpleAir-" + id;
        document.getElementById("modal_chartSensor").style.display = 'none';
        document.getElementById("modal_chartSensor2").style.display = 'block';


        console.log("Create Empty Amcharts");
            if (root4 != undefined) {
              console.log("DISPOSE")
              root4.dispose();
          }
          setTimeout(function() {
              am5.ready(function() {
                  root4 = am5.Root.new("modal_chartSensor2");
                  root4.setThemes([
                      am5themes_Animated.new(root4)
                  ]);

                  var chart4 = root4.container.children.push(am5xy.XYChart.new(root4, {
                      panX: true,
                      panY: true,
                      wheelX: "panX",
                      wheelY: "zoomX",
                      maxTooltipDistance: 0,
                      pinchZoomX: true
                  }));

                  // Create axes
                  // https://www.amcharts.com/docs/v5/charts/xy-chart/axes/
                  var xAxis = chart4.xAxes.push(am5xy.DateAxis.new(root4, {
                      maxDeviation: 0.2,
                      baseInterval: {
                          timeUnit: "minute",
                          count: 1
                      },
                      renderer: am5xy.AxisRendererX.new(root4, {}),
                      tooltip: am5.Tooltip.new(root4, {})
                  }));

                  var yAxis = chart4.yAxes.push(am5xy.ValueAxis.new(root4, {
                      renderer: am5xy.AxisRendererY.new(root4, {})
                  }));


                  var modal = am5.Modal.new(root4, {
                      content: "L'API PurpleAir n'est pas ouverte."
                  });

                  modal.open();

                  var legend = chart4.bottomAxesContainer.children.push(am5.Legend.new(root4, {
                    width: 400,
                    height: am5.percent(20),
                    layout: root4.horizontalLayout,
                }));


                  // When legend item container is hovered, dim all the series except the hovered one
                  legend.itemContainers.template.events.on("pointerover", function(e) {
                      var itemContainer = e.target;

                      // As series list is data of a legend, dataContext is series
                      var series = itemContainer.dataItem.dataContext;

                      chart4.series.each(function(chartSeries) {
                          if (chartSeries != series) {
                              chartSeries.strokes.template.setAll({
                                  strokeOpacity: 0.15,
                                  stroke: am5.color(0x000000)
                              });
                          } else {
                              chartSeries.strokes.template.setAll({
                                  strokeWidth: 3
                              });
                          }
                      })
                  })

                  // When legend item container is unhovered, make all series as they are
                  legend.itemContainers.template.events.on("pointerout", function(e) {
                      var itemContainer = e.target;
                      var series = itemContainer.dataItem.dataContext;

                      chart4.series.each(function(chartSeries) {
                          chartSeries.strokes.template.setAll({
                              strokeOpacity: 1,
                              strokeWidth: 1,
                              stroke: chartSeries.get("fill")
                          });
                      });
                  })

                  legend.itemContainers.template.set("width", am5.p100);
                  legend.valueLabels.template.setAll({
                      width: am5.p100,
                      textAlign: "right"
                  });

                  // It's is important to set legend data after all the events are set on template, otherwise events won't be copied
                  legend.data.setAll(chart4.series.values);

                  chart4.children.unshift(am5.Label.new(root4, {
                    fontSize: 14,
                    textAlign: "center",
                    x: am5.percent(50),
                    centerX: am5.percent(50)
                  }));


                  var exporting = am5plugins_exporting.Exporting.new(root4, {
menu: am5plugins_exporting.ExportingMenu.new(root4, {}),
dataSource: null
});

                  // Make stuff animate on load
                  // https://www.amcharts.com/docs/v5/concepts/animations/
                  chart4.appear(1000, 100);

              })
          }, 1000); // end am5.ready()


















        document.getElementById("modal_button1h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',1,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
        document.getElementById("modal_button3h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',3,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>3h</button>';
        document.getElementById("modal_button24h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',24,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>24h</button>';
        document.getElementById("modal_button48h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',48,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>48h</button>';
        document.getElementById("modal_button1s").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',168,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>1 semaine</button>';
        document.getElementById("modal_button1m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',720,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>1 mois</button>';
        document.getElementById("modal_button1a").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',8760,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm" disabled>1 an</button>';
        document.getElementById("modal_button2m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',2)" class="btn btn-outline-secondary btn-sm" disabled>2m</button>';
        document.getElementById("modal_button15m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',15)" class="btn btn-outline-secondary btn-sm" disabled>15m</button>';
        document.getElementById("modal_button60m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',60)" class="btn btn-outline-secondary btn-sm" disabled>1h</button>';
        document.getElementById("modal_button1440m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',1440)" class="btn btn-outline-secondary btn-sm" disabled>24h</button>';






        //         load1PurpleAir(id,timeLengthGraph,timespanGraph);
        //         document.getElementById("modal_chartSensor").style.display = 'none';
        //         document.getElementById("modal_chartSensor2").style.display = 'block';
        //         document.getElementById("modal_button1h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',1,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm">1h</button>';
        //         document.getElementById("modal_button3h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',3,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm">3h</button>';
        //         document.getElementById("modal_button24h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',24,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm">24h</button>';
        //         document.getElementById("modal_button48h").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',48,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm">48h</button>';
        //         document.getElementById("modal_button1s").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',168,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm">1 semaine</button>';
        //         document.getElementById("modal_button1m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',720,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm">1 mois</button>';
        //         document.getElementById("modal_button1a").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',8760,' + timespanLower + ')" class="btn btn-outline-secondary btn-sm">1 an</button>';
        //         document.getElementById("modal_button2m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',2)" class="btn btn-outline-secondary btn-sm">2m</button>';
        //         document.getElementById("modal_button15m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',15)" class="btn btn-outline-secondary btn-sm">15m</button>';
        //         document.getElementById("modal_button60m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',60)" class="btn btn-outline-secondary btn-sm">1h</button>';
        //         document.getElementById("modal_button1440m").innerHTML = '<button type="button" onclick="chooseTimePurpleAir(\'' + id + '\',' + timeLength + ',1440)" class="btn btn-outline-secondary btn-sm">24h</button>';
        //         buttonsSwitcher(timeLength,timespanLower,true);

        //        if(timespanLower == 2 || timespanLower == 15){
        //       document.getElementById("button1a").children[0].setAttribute("disabled","");
        //     }else{
        //       document.getElementById("button1a").children[0].removeAttribute("disabled");
        //     }

        //     if(timeLength == 8760){
        //       document.getElementById("button2m").children[0].setAttribute("disabled","");
        //       document.getElementById("button15m").children[0].setAttribute("disabled","");
        //     }else{
        //       document.getElementById("button2m").children[0].removeAttribute("disabled");
        //       document.getElementById("button15m").children[0].removeAttribute("disabled");
        //     }


        document.getElementById("modal_lastseen").innerText = "Dernière mesure effectuée : " + data2;

if(data3 != -1){
document.getElementById("modal_wifilevel").innerText = "Qualité connexion WIFI : " + data3 + "%";
}else if(data3 == -1 && type != "sensorcommunity"){
//   document.getElementById("modal_wifilevel").innerText = "Capteur déconnecté";
  document.getElementById("modal_wifilevel").innerText = "";
}else{
  document.getElementById("modal_wifilevel").innerText = "Capteur connecté";
}


        }

    
}



setInterval(function() {
    console.log("Setinterval:");
    console.log(timespanLower * 60 * 1000);
    console.log(Date.now() - apiFetchNebuleAir.timestamp);

if (document.querySelector("#checkbox_micro_stationsParticuliers").checked) {
    if (apiFetchNebuleAir.data.length == 0 || (apiFetchNebuleAir.data.length != 0 && Date.now() - apiFetchNebuleAir.timestamp > timespanLower * 60 * 1000 - 1000)) {
            loadNebuleAir();
            openToast("Données NebuleAir rechargées");
        }
}

if (document.querySelector("#checkbox_sensor_community").checked) {
    if (apiFetchSensorCommunity.data.length == 0 || (apiFetchSensorCommunity.data.length != 0 && Date.now() - apiFetchSensorCommunity.timestamp > timespanLower * 60 * 1000 - 1000)) {
            loadSensorCommunity();
            openToast("Données Sensor.Community rechargées");
        }
}

if (document.querySelector("#checkbox_stationsRefAtmoSud").checked) {
    if (apiFetchAtmoSudRef.data.length == 0 || (apiFetchAtmoSudRef.data.length != 0 && Date.now() - apiFetchAtmoSudRef.timestamp > timespanLower * 60 * 1000 - 1000)) {
            loadStationRefAtmo();
            openToast("Données Atmo sations de reférence rechargées");
        }
}

if (document.querySelector("#checkbox_micro_stationsAtmoSud").checked) {
    if (apiFetchAtmoSudMicro.data.length == 0 || (apiFetchAtmoSudMicro.data.length != 0 && Date.now() - apiFetchAtmoSudMicro.timestamp > timespanLower * 60 * 1000 - 1000)) {
            loadStationMicroAtmo();
            openToast("Données Atmo microstations rechargées");
        }
}

if (document.querySelector("#checkbox_modelisationPMAtmoSud").checked && timespanLower == 60) {
    loadModelisationPMAtmo();
    openToast("Modélisation Atmo PM rechargée");
}

if (document.querySelector("#checkbox_modelisationICAIRAtmoSud").checked && timespanLower == 60) {
    loadModelisationICAIRAtmo();
    openToast("Modélisation Atmo ICAIR rechargée");
}

if (document.querySelector("#checkbox_purpleAir").checked) {
    if (apiFetchPurpleAir.data.length == 0 || (apiFetchPurpleAir.data.length != 0 && Date.now() - apiFetchPurpleAir.timestamp > timespanLower * 60 * 1000 - 1000)) {
            loadPurpleAir();
            openToast("Données PurpleAir rechargées");
        }
}

}, timespanLower * 60 * 1000)

setInterval(function() {

if (document.querySelector("#checkbox_wind").checked) {

    velocityLayer.remove();
    const current_time = new Date();
                let day = String(current_time.getFullYear());
                if((current_time.getMonth()+1)< 10){
                    day += "0";
                    day += (current_time.getMonth()+1);
                }else{
                    day += (current_time.getMonth()+1);
                }
                if(current_time.getDate()< 10){
                    day += "0";
                    day += current_time.getDate();
                }else{
                    day += current_time.getDate();
                }
                let hour ="";
                if(current_time.getHours()< 10){
                    hour += "0";
                    hour += current_time.getHours();
                }else{
                    hour += current_time.getHours();
                }

                let wind_link = "https://meteo.atmosud.org/"+ day +"/wind_field_" + hour +".json";  
                console.log(wind_link);

                $.getJSON(wind_link, function(data) {
                 velocityLayer =  L.velocityLayer({
                                        displayValues: false,
                                        displayOptions: false,
                                        data: data,
                                        velocityScale: 0.015,
                                        colorScale: ["#71C3F2", "#447591"],
                                        minVelocity: 1,
                                        maxVelocity: 10,
                                        overlayName: 'wind_layer',
                                    }).addTo(map);
                });

            openToast("Données Vent rechargées");
}

}, 60 * 60 * 1000)

    </script>

    <!-- Bootstrap 5.3.0 -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
    <script>
        var tooltipTriggerList = [].slice.call(
            document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        const screenTooSmall_modal = new bootstrap.Modal('#screen_tooSmall_Modal');
        if (screen.width < 1080) {
            screenTooSmall_modal.show();
            var btns = document.getElementsByClassName('btn');
            for (const btn of btns) {
                btn.classList.add('btn-sm');
                }
        }

        //welcome mdodal (open at startup with cookies or with button_openWelcomeModal)
        const welcomeModal = new bootstrap.Modal('#welcome_Modal');
        
        if (Cookies.get('welcome') == null) {
            welcomeModal.show();
            Cookies.set('welcome', 'oui', { expires: 7 });
        }

        function openWelcomeModal() {
            welcomeModal.show();
        }


        const sensorPanelModal = new bootstrap.Modal('#sensorPanel_Modal');
        const sensorPanelModal2 = new bootstrap.Modal('#sensorPanel_Modal2');





       
 var fullScreenMode = false;

function fullScreen() {
    console.log("full screen mode");
    if (fullScreenMode == false) {
        document.getElementById("sidePanelCol").classList.replace("col-5", "col-12");
        fullScreenMode = true;
    }else{
        document.getElementById("sidePanelCol").classList.replace("col-12", "col-5");
        fullScreenMode = false;
    }
    
}
    </script>
</body>

</html>